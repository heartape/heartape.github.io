(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{527:function(s,a,t){"use strict";t.r(a);var n=t(0),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"_1-mysql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-mysql"}},[s._v("#")]),s._v(" 1.mysql")]),s._v(" "),a("h3",{attrs:{id:"_1-索引"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-索引"}},[s._v("#")]),s._v(" 1.索引")]),s._v(" "),a("h3",{attrs:{id:"_2-mvcc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-mvcc"}},[s._v("#")]),s._v(" 2.mvcc")]),s._v(" "),a("p",[s._v("MVCC (MultiVersion Concurrency Control) 叫做多版本并发控制。")]),s._v(" "),a("p",[s._v("InnoDB的 MVCC ，是通过在每行记录的后面保存两个隐藏的列来实现的。\n这两个列， 一个保存了行的创建版本号，一个保存了行的过期版本号。")]),s._v(" "),a("h3",{attrs:{id:"_3-锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-锁"}},[s._v("#")]),s._v(" 3.锁")]),s._v(" "),a("p",[s._v("在事务中因为需要解决脏读、幻读等问题需要加锁，只会在事务提交时才会被释放。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 通过创建innodb_monitor开启监控")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" innodb_monitor "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENGINE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INNODB")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DROP")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" innodb_monitor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 通过参数开启监控")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GLOBAL")]),s._v(" innodb_status_output_locks"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GLOBAL")]),s._v(" innodb_status_output_locks"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("OFF")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查看事务 ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" information_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("INNODB_TRX"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("ul",[a("li",[s._v("全局锁: 全库逻辑备份（mysqldump），命令 "),a("code",[s._v("Flush tables with read lock (FTWRL)")]),s._v("，会导致业务停止，主从延迟。")]),s._v(" "),a("li",[s._v("表级锁:\n"),a("ul",[a("li",[s._v("lock: "),a("code",[s._v("unlock tables;")]),s._v("解锁。\n"),a("ul",[a("li",[a("code",[s._v("lock tables book read;")]),s._v("，当前连接可以读，写报错。其他连接可以读，写等待。")]),s._v(" "),a("li",[a("code",[s._v("lock tables book write;")]),s._v("，当前连接可以写，读等待。其他连接读写等待。")])])]),s._v(" "),a("li",[s._v("元数据锁(MDL): 不需要显式使用。增删改查操作的时候，加MDL读锁；当要对表做结构变更操作的时候，加MDL写锁。")])])]),s._v(" "),a("li",[s._v("行级锁: 粒度最低的锁。行锁通过锁索引（一定会锁主键索引）来加锁，因为每次都通过where查找索引给数据加锁性能太低，这也导致了没有索引的情况会锁表。")])]),s._v(" "),a("h5",{attrs:{id:"共享锁、排它锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#共享锁、排它锁"}},[s._v("#")]),s._v(" 共享锁、排它锁")]),s._v(" "),a("ul",[a("li",[s._v("共享锁(s)"),a("code",[s._v("select * from book where id = 1 lock in share mode")]),s._v(": permits the transaction that holds the lock to read a row.")]),s._v(" "),a("li",[s._v("排它锁(x)"),a("code",[s._v("select * from book where id = 1 for update")]),s._v(": permits the transaction that holds the lock to update or delete a row.a request from some distinct transaction for a lock of either type on cannot be granted immediately. transaction has to wait for transaction to release its lock on row.")])]),s._v(" "),a("h5",{attrs:{id:"记录锁、间隙锁、临键锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#记录锁、间隙锁、临键锁"}},[s._v("#")]),s._v(" 记录锁、间隙锁、临键锁")]),s._v(" "),a("ul",[a("li",[s._v("记录锁: "),a("code",[s._v("select * from student where id = 3 for update")])]),s._v(" "),a("li",[s._v("间隙锁:\n"),a("ul",[a("li",[a("code",[s._v("select * from student where id = 5 for update")]),s._v("（id主键索引，有值3、7，没有5）;")]),s._v(" "),a("li",[a("code",[s._v("select * from student where id = 35 for update")]),s._v("（age普通索引，有值25、36）")])])]),s._v(" "),a("li",[s._v("临键锁: "),a("code",[s._v("select * from student where age = 36 for update")]),s._v("（age普通索引，有值25、36、45）")])]),s._v(" "),a("div",{staticClass:"language-text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("记录锁\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n|                  2334 | flink         | student     | NULL       | TABLE     | IX            | GRANTED     | NULL      |\n|                  2334 | flink         | student     | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 1         |\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n\n间隙锁(id in (4, 6)会被锁住)\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+\n|                  2359 | flink         | student     | NULL       | TABLE     | IX        | GRANTED     | NULL      |\n|                  2359 | flink         | student     | PRIMARY    | RECORD    | X,GAP     | GRANTED     | 6         |\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+\n\n间隙锁(age in (26, 35)会被锁住)\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+\n|                  2435 | flink         | student     | NULL       | TABLE     | IX        | GRANTED     | NULL      |\n|                  2435 | flink         | student     | age        | RECORD    | X,GAP     | GRANTED     | 36, 15    |\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+\n\n临键锁(age in (26, 44) or id=15会被锁住，普通索引命中反而锁得更多)\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n|                  2418 | flink         | student     | NULL       | TABLE     | IX            | GRANTED     | NULL      |\n|                  2418 | flink         | student     | age        | RECORD    | X             | GRANTED     | 36, 15    |\n|                  2418 | flink         | student     | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 15        |\n|                  2418 | flink         | student     | age        | RECORD    | X,GAP         | GRANTED     | 45, 1     |\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br")])]),a("h5",{attrs:{id:"意向锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#意向锁"}},[s._v("#")]),s._v(" 意向锁")]),s._v(" "),a("p",[s._v("Intention locks are table-level locks that indicate which type of lock (shared or exclusive) a transaction requires later for a row in a table.\nA lock is granted to a requesting transaction if it is compatible with existing locks, but not if it conflicts with existing locks.\nA transaction waits until the conflicting existing lock is released.\nIf a lock request conflicts with an existing lock and cannot be granted because it would cause deadlock, an error occurs.")]),s._v(" "),a("p",[s._v("大致意思就是，意向锁是一种提前声明，声明了当前表有共享锁或排它锁，省去每次扫描。虽然是表锁，其他事务在不冲突的情况下也可以获取锁。")]),s._v(" "),a("p",[s._v("分类:")]),s._v(" "),a("ul",[a("li",[s._v("意向共享锁: a transaction intends to set a shared lock on individual rows in a table.(IS)"),a("code",[s._v("SELECT ... FOR SHARE")]),s._v("。")]),s._v(" "),a("li",[s._v("意向排它锁: a transaction intends to set an exclusive lock on individual rows in a table.(IX)"),a("code",[s._v("SELECT ... FOR UPDATE")]),s._v("。")])]),s._v(" "),a("p",[s._v("协议:")]),s._v(" "),a("ul",[a("li",[s._v("意向共享锁: Before a transaction can acquire a shared lock on a row in a table, it must first acquire an lock or stronger on the table.")]),s._v(" "),a("li",[s._v("意向排它锁: Before a transaction can acquire an exclusive lock on a row in a table, it must first acquire an lock on the table.")])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 意向共享锁")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" book "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHARE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- lock")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" ENGINE_TRANSACTION_ID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("OBJECT_SCHEMA"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("OBJECT_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("INDEX_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("LOCK_TYPE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("LOCK_MODE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("LOCK_STATUS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("LOCK_DATA "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" performance_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("data_locks"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- innodb")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("engine")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("innodb")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMIT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("div",{staticClass:"language-text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("锁信息:\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA              |\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+\n|       421428622781656 | flink         | book        | NULL       | TABLE     | IS        | GRANTED     | NULL                   |\n|       421428622781656 | flink         | book        | PRIMARY    | RECORD    | S         | GRANTED     | 1                      |\n|       421428622781656 | flink         | book        | PRIMARY    | RECORD    | S         | GRANTED     | 2                      |\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+\n\n可以看到IS锁并不用来锁住数据，本质上还是使用记录锁。下面是意向锁锁全表时的记录:\n\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA              |\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+\n|       421428622781656 | flink         | book        | NULL       | TABLE     | IS        | GRANTED     | NULL                   |\n|       421428622781656 | flink         | book        | PRIMARY    | RECORD    | S         | GRANTED     | supremum pseudo-record |\n|       421428622781656 | flink         | book        | PRIMARY    | RECORD    | S         | GRANTED     | 1                      |\n|       421428622781656 | flink         | book        | PRIMARY    | RECORD    | S         | GRANTED     | 2                      |\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 意向排它锁")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" book "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- lock")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" ENGINE_TRANSACTION_ID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("OBJECT_SCHEMA"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("OBJECT_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("INDEX_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("LOCK_TYPE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("LOCK_MODE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("LOCK_STATUS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("LOCK_DATA "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" performance_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("data_locks"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- innodb")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("engine")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("innodb")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMIT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("div",{staticClass:"language-text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("锁信息:\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n|                  2869 | test          | book        | NULL       | TABLE     | IX            | GRANTED     | NULL      |\n|                  2869 | test          | book        | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 1         |\n|                  2869 | test          | book        | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 2         |\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n\n可以看到IX锁并不用来锁住数据，本质上还是使用记录锁。下面是意向锁锁全表时的记录:\n\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+------------------------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA              |\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+------------------------+\n|                  2869 | test          | book        | NULL       | TABLE     | IX            | GRANTED     | NULL                   |\n|                  2869 | test          | book        | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | supremum pseudo-record |\n|                  2869 | test          | book        | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 1                      |\n|                  2869 | test          | book        | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 2                      |\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+------------------------+\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("h5",{attrs:{id:"插入意向锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#插入意向锁"}},[s._v("#")]),s._v(" 插入意向锁")]),s._v(" "),a("p",[s._v("An insert intention lock is a type of gap lock(间隙锁)。官方文档将插入意向锁作为单独一种。")]),s._v(" "),a("p",[s._v("连接1")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" book "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("div",{staticClass:"language-text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("查看锁信息\nTABLE LOCK table `flink`.`book` trx id 2328 lock mode IX\nRECORD LOCKS space id 2 page no 4 n bits 72 index PRIMARY of table `flink`.`book` trx id 2328 lock_mode X\n\n+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE          | LOCK_STATUS | LOCK_DATA              |\n+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+\n|                  2328 | flink         | book        | NULL       | TABLE     | IX                 | GRANTED     | NULL                   |\n|                  2328 | flink         | book        | PRIMARY    | RECORD    | X                  | GRANTED     | supremum pseudo-record |\n|                  2328 | flink         | book        | PRIMARY    | RECORD    | X                  | GRANTED     | 2                      |\n|                  2328 | flink         | book        | PRIMARY    | RECORD    | X                  | GRANTED     | 3                      |\n+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("连接2")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 执行并等待")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("book"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'代数'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("再次查看锁")]),s._v(" "),a("div",{staticClass:"language-text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("RECORD LOCKS space id 2 page no 4 n bits 72 index PRIMARY of table `flink`.`book` trx id 2329 lock_mode X insert intention waiting\n\nTABLE LOCK table `flink`.`book` trx id 2328 lock mode IX\nRECORD LOCKS space id 2 page no 4 n bits 72 index PRIMARY of table `flink`.`book` trx id 2328 lock_mode X\n\n+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE          | LOCK_STATUS | LOCK_DATA              |\n+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+\n|                  2331 | flink         | book        | NULL       | TABLE     | IX                 | GRANTED     | NULL                   |\n|                  2331 | flink         | book        | PRIMARY    | RECORD    | X,INSERT_INTENTION | WAITING     | supremum pseudo-record |\n|                  2328 | flink         | book        | NULL       | TABLE     | IX                 | GRANTED     | NULL                   |\n|                  2328 | flink         | book        | PRIMARY    | RECORD    | X                  | GRANTED     | supremum pseudo-record |\n|                  2328 | flink         | book        | PRIMARY    | RECORD    | X                  | GRANTED     | 2                      |\n|                  2328 | flink         | book        | PRIMARY    | RECORD    | X                  | GRANTED     | 3                      |\n+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+\n无法获取到锁，随后insert失败。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("h3",{attrs:{id:"_4-事务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-事务"}},[s._v("#")]),s._v(" 4.事务")]),s._v(" "),a("p",[s._v("事务的特点:")]),s._v(" "),a("ul",[a("li",[s._v("原子性(Atomicity)")]),s._v(" "),a("li",[s._v("一致性(Consistency)")]),s._v(" "),a("li",[s._v("隔离型(Isolation)")]),s._v(" "),a("li",[s._v("持久性(Durability)")])]),s._v(" "),a("p",[s._v("隔离级别")]),s._v(" "),a("div",{staticClass:"language-text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("- READ UNCOMMITED (读未提交): 不加锁，事物之间公开透明。脏读。\n- READ COMMITED (读已提交): 写加锁，读mvcc。因为在每次select时都会生成一个版本，所以会读取到其他事务已提交的数据，导致事务内读取前后不一致。不可重读、幻读。\n- REPEATABLE READ (可重复读): 写加锁，读mvcc。只会在最初select时生成一个版本，但是update, delete, insert等是当前读能操作select不到的数据。幻读。\n- SERIALIZABLE (串行化): 顺序读写。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("事务等待信息查看")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v("\n  r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("trx_id waiting_trx_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n  r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("trx_mysql_thread_id waiting_thread"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n  r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("trx_query waiting_query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n  b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("trx_id blocking_trx_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n  b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("trx_mysql_thread_id blocking_thread"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n  b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("trx_query blocking_query \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" \n  performance_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("data_lock_waits w \n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INNER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("JOIN")]),s._v(" information_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("innodb_trx b \n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("trx_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" w"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("blocking_engine_transaction_id \n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INNER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("JOIN")]),s._v(" information_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("innodb_trx r \n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" r"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("trx_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" w"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("requesting_engine_transaction_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h4",{attrs:{id:"redo-log"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redo-log"}},[s._v("#")]),s._v(" redo log")]),s._v(" "),a("div",{staticClass:"language-text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mysql为了减少硬盘IO提升性能，引入了Boffer Pool(缓冲池)。\n查询一条记录，先从Buffer Pool中找，没有命中会从硬盘把一页的数据加载出来，放入到Buffer Pool中。\n修改也是会先存到Boffer Pool里头。\n然后使用后台线程去做缓冲池和磁盘之间的同步。\n此时，便需要使用redo log来记录这部分尚未写入数据，防止数据丢失。\n\nredo log叫做重做日志，是用来实现事务的持久性。\n该日志文件由两部分组成: 重做redo log buffer（日志缓冲）以及redo log（重做日志文件），前者是在内存中，后者在磁盘中。\n\nredo log有以下特性:\n- 顺序存储，写入性能更好。\n- 只要事务一提交，便将redo log buffer刷盘到redo log，保证事务的持久性(innodb_flush_log_at_trx_commit=1)。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h4",{attrs:{id:"undo-log"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#undo-log"}},[s._v("#")]),s._v(" undo log")]),s._v(" "),a("div",{staticClass:"language-text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("undo log叫做回滚日志，用于记录数据被修改前的信息。\n\nundo log的作用:\n- 如果事务回滚，就会将undo log中的数据恢复。\n- undo log保存了开启事务前的数据，可以作为mvcc旧版本快照的数据，以供快照读。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h4",{attrs:{id:"提交方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#提交方式"}},[s._v("#")]),s._v(" 提交方式")]),s._v(" "),a("div",{staticClass:"language-text line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("- 显示提交（显式事务）: begin; 'sql'; commit/rollback。此时相当于autocommit=OFF。\n- 隐式提交（隐式事务）: 在没有显式开启事务时，会为单个sql开启隐式事务。隐式提交会自动在sql语句后提交。需要autocommit=ON，否则需要手动commit。\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("显示提交:")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("book"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("title"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'牛x'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMIT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("隐式提交:"),a("br"),s._v("\n连接1")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" VARIABLES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("LIKE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'autocommit'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" autocommit "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("OFF")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("book"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("title"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'牛x'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("连接2会等待")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("book"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("title"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'牛xx'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token identifier"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);