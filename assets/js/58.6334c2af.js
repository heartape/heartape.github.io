(window.webpackJsonp=window.webpackJsonp||[]).push([[58],{537:function(t,s,a){"use strict";a.r(s);var n=a(0),r=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"_1-简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介"}},[t._v("#")]),t._v(" 1.简介")]),t._v(" "),s("p",[t._v("目前oauth2应用较为广泛，配合oidc可以实现公共的认证授权的服务。\n但目前提供oauth2认证服务的产品并不规范，甚至可以说是混乱。\nspring官方也意识到，所以废弃了原本spring-security-oauth2，将oauth2做成了spring-security的插件。\n后来迫于社区压力，又开启了spring-authorization-server项目，至此spring的oauth2算是重新建立。")]),t._v(" "),s("blockquote",[s("p",[t._v("注意！本文仅讨论spring的oauth2体系，与其他产品会有不同。")])]),t._v(" "),s("h2",{attrs:{id:"_2-架构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-架构"}},[t._v("#")]),t._v(" 2.架构")]),t._v(" "),s("h3",{attrs:{id:"_1-主要依赖"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-主要依赖"}},[t._v("#")]),t._v(" 1.主要依赖")]),t._v(" "),s("div",{staticClass:"language-xml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependencies")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!--公共依赖--\x3e")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.springframework.boot"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("spring-boot-starter-security"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!--客户端--\x3e")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.springframework.boot"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("spring-boot-starter-oauth2-client"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!--资源服务器--\x3e")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.springframework.boot"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("spring-boot-starter-oauth2-resource-server"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!--认证服务器--\x3e")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.springframework.security"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("spring-security-oauth2-authorization-server"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("1.0.0"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependencies")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br")])]),s("h3",{attrs:{id:"_2-流程分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-流程分析"}},[t._v("#")]),t._v(" 2.流程分析")]),t._v(" "),s("p",[t._v("一般来说，客户端、资源服务器独立运行，仅在进行认证时依赖于认证服务器。")]),t._v(" "),s("p",[t._v("要分析流程，就不得不从各个服务的配置说起：")]),t._v(" "),s("ul",[s("li",[t._v("client指向authorization-server")]),t._v(" "),s("li",[t._v("resource-server指向authorization-server（也可以将公钥配置到资源服务器）")]),t._v(" "),s("li",[t._v("authorization-server保存各个账户的认证授权信息（包括合法的认证方式和回调地址），某些情况也会保存用户个人信息")])]),t._v(" "),s("p",[t._v("用户可感知的oauth2流程（以授权码模式为例）：")]),t._v(" "),s("ul",[s("li",[t._v("用户选择一个认证中心进行登录")]),t._v(" "),s("li",[t._v("随后进行授权")]),t._v(" "),s("li",[t._v("跳转回首页")])]),t._v(" "),s("p",[t._v("实际的oauth2流程（以授权码模式为例）：")]),t._v(" "),s("ul",[s("li",[t._v("user选择认证中心")]),t._v(" "),s("li",[t._v("验证client账号密码,并将验证字段state发送到server")]),t._v(" "),s("li",[t._v("user登录")]),t._v(" "),s("li",[t._v("user授权")]),t._v(" "),s("li",[t._v("server返回授权码和验证字段，client对其校验")]),t._v(" "),s("li",[t._v("client获取token")]),t._v(" "),s("li",[t._v("client获取userinfo")]),t._v(" "),s("li",[t._v("跳转client根地址")]),t._v(" "),s("li",[t._v("client从资源服务器获取数据")])]),t._v(" "),s("h2",{attrs:{id:"_3-源码分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-源码分析"}},[t._v("#")]),t._v(" 3.源码分析")]),t._v(" "),s("h3",{attrs:{id:"_1-client"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-client"}},[t._v("#")]),t._v(" 1.client")]),t._v(" "),s("p",[t._v("过滤器:")]),t._v(" "),s("ol",[s("li",[t._v("OAuth2AuthorizationCodeGrantFilter: 接收授权码，然后验证并存储")]),t._v(" "),s("li",[t._v("OAuth2LoginAuthenticationFilter: server回调,返回code和state")])]),t._v(" "),s("h3",{attrs:{id:"_2-resource-server"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-resource-server"}},[t._v("#")]),t._v(" 2.resource-server")]),t._v(" "),s("ol",[s("li",[t._v("OAuth2ResourceServerJwtConfiguration: 配置jwk-set-uri，用于请求server并获取公钥")]),t._v(" "),s("li",[t._v("RestOperationsResourceRetriever: 通过http请求向server发送请求")])]),t._v(" "),s("h3",{attrs:{id:"_3-authorization-server"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-authorization-server"}},[t._v("#")]),t._v(" 3.authorization-server")]),t._v(" "),s("p",[t._v("过滤器:")]),t._v(" "),s("ol",[s("li",[t._v("OAuth2AuthorizationServerMetadataEndpointFilter: 元信息")]),t._v(" "),s("li",[t._v("OAuth2AuthorizationEndpointFilter: 认证")]),t._v(" "),s("li",[t._v("OAuth2TokenEndpointFilter: token")]),t._v(" "),s("li",[t._v("NimbusJwkSetEndpointFilter: 公钥")])]),t._v(" "),s("h2",{attrs:{id:"_4-其他"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-其他"}},[t._v("#")]),t._v(" 4.其他")]),t._v(" "),s("ul",[s("li",[t._v("由于spring采用了session来存储授权码、验证字段和token等，在分布式情况下会存在请求失败的问题。目前官方建议使用spring-session来共享。")]),t._v(" "),s("li",[t._v("可以通过自定义userMapper修改userinfo。")]),t._v(" "),s("li",[t._v("可以配合gateway使用，由于spring-security采用的是过滤器，会优先生效。")]),t._v(" "),s("li",[t._v("rsa密钥（可以通过openssl生成）中的kid没有密码学上的意义，只是用来寻找密钥的索引。")])]),t._v(" "),s("h2",{attrs:{id:"_5-示例代码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-示例代码"}},[t._v("#")]),t._v(" 5.示例代码")]),t._v(" "),s("p",[t._v("许多内容我已经在源码中进行了标注。")]),t._v(" "),s("blockquote",[s("p",[s("a",{attrs:{href:"https://github.com/heartape/study/tree/main/frame/spring-security/spring-security-oauth2",target:"_blank",rel:"noopener noreferrer"}},[t._v("源代码-github"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=r.exports}}]);