(window.webpackJsonp=window.webpackJsonp||[]).push([[60],{538:function(e,t,s){"use strict";s.r(t);var a=s(0),n=Object(a.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h2",{attrs:{id:"_1-简介"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介"}},[e._v("#")]),e._v(" 1.简介")]),e._v(" "),t("p",[e._v("websocket集实时性与性能于一身，在im领域有其一席之地。java目前一般是采用netty和spring来实现。")]),e._v(" "),t("h2",{attrs:{id:"_2-netty"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-netty"}},[e._v("#")]),e._v(" 2.netty")]),e._v(" "),t("p",[e._v("如果要实现websocket，netty当然是最好的选择之一。性能强劲，没有多余的代理，代码设计简洁优雅都是他的优点。")]),e._v(" "),t("blockquote",[t("p",[t("a",{attrs:{href:"https://github.com/heartape/study/tree/main/frame/netty/netty-websocket",target:"_blank",rel:"noopener noreferrer"}},[e._v("github"),t("OutboundLink")],1)])]),e._v(" "),t("p",[e._v("代码没有什么难点，只不过在返回消息时需要包装成"),t("code",[e._v("TextWebSocketFrame")]),e._v("，不然会收不到消息。。。")]),e._v(" "),t("h2",{attrs:{id:"_3-spring"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-spring"}},[e._v("#")]),e._v(" 3.spring")]),e._v(" "),t("p",[e._v("虽然netty很优秀，但是考虑到spring强大的生态，如果不是作为一家公司的核心产品的话，spring将是首选，因为不需要造轮子可以快速开发。")]),e._v(" "),t("blockquote",[t("p",[t("a",{attrs:{href:"https://github.com/heartape/study/tree/main/frame/spring-websocket",target:"_blank",rel:"noopener noreferrer"}},[e._v("github"),t("OutboundLink")],1)])]),e._v(" "),t("p",[e._v("代码没有使用注解的方式，与netty的代码几乎一致，包括返回消息也需要包装一下。\nspring也提供了java标准注解的实现 "),t("RouterLink",{attrs:{to:"/blogs/2023/websocket.html"}},[e._v("上一篇文章")])],1),e._v(" "),t("h2",{attrs:{id:"_4-问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-问题"}},[e._v("#")]),e._v(" 4.问题")]),e._v(" "),t("p",[e._v("如果使用websocket协议搭建im平台的话，不得不考虑鉴权的问题。\n网络上的说法无非是将token放到param或者Sec-WebSocket-Protocol中，因为协议中其他请求头都不可以修改。\n放到param有安全性问题，而放到Sec-WebSocket-Protocol则与其设计含义完全相悖，是极其不规范的操作。\n从这里也可以看出，websocket在设计上就不打算在建立连接时做复杂操作。")]),e._v(" "),t("p",[e._v("我也找了一些商业产品，文档内介绍的做法是将token放到消息体内，也算是当前最合理的方案。")]),e._v(" "),t("h2",{attrs:{id:"_5-stomp"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-stomp"}},[e._v("#")]),e._v(" 5.stomp")]),e._v(" "),t("h3",{attrs:{id:"_1-简介-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介-2"}},[e._v("#")]),e._v(" 1.简介")]),e._v(" "),t("p",[e._v("鉴于上面的问题，用stomp是更为适合的方案。\nSTOMP，Streaming Text Orientated Message Protocol，是流文本定向消息协议，是一种为MOM(Message Oriented Middleware，面向消息的中间件)设计的简单文本协议。\n很多消息中间件支持该协议，可以提高应用的兼容性和扩展性（spring就可以代理到外部中间件）。")]),e._v(" "),t("h3",{attrs:{id:"_2-报文"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-报文"}},[e._v("#")]),e._v(" 2.报文")]),e._v(" "),t("p",[e._v("握手请求")]),e._v(" "),t("div",{staticClass:"language-text line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("GET ws://127.0.0.1:8088/chat HTTP/1.1\nHost: 127.0.0.1:8088\nConnection: Upgrade\nPragma: no-cache\nCache-Control: no-cache\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36\nUpgrade: websocket\nOrigin: http://localhost:63342\nSec-WebSocket-Version: 13\nAccept-Encoding: gzip, deflate, br\nAccept-Language: zh-CN,zh;q=0.9\nSec-WebSocket-Key: m9whBt/NBNR8E2D56W6PaA==\nSec-WebSocket-Extensions: permessage-deflate; client_max_window_bits\nSec-WebSocket-Protocol: v10.stomp, v11.stomp\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br"),t("span",{staticClass:"line-number"},[e._v("8")]),t("br"),t("span",{staticClass:"line-number"},[e._v("9")]),t("br"),t("span",{staticClass:"line-number"},[e._v("10")]),t("br"),t("span",{staticClass:"line-number"},[e._v("11")]),t("br"),t("span",{staticClass:"line-number"},[e._v("12")]),t("br"),t("span",{staticClass:"line-number"},[e._v("13")]),t("br"),t("span",{staticClass:"line-number"},[e._v("14")]),t("br")])]),t("p",[e._v("握手响应")]),e._v(" "),t("div",{staticClass:"language-text line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("HTTP/1.1 101\nUpgrade: websocket\nConnection: upgrade\nSec-WebSocket-Accept: hJceVmUrjTMSP2Zgrug9PFS0YMA=\nSec-WebSocket-Protocol: v10.stomp\nSec-WebSocket-Extensions: permessage-deflate;client_max_window_bits=15\nX-Content-Type-Options: nosniff\nX-XSS-Protection: 0\nCache-Control: no-cache, no-store, max-age=0, must-revalidate\nPragma: no-cache\nExpires: 0\nX-Frame-Options: DENY\nDate: Mon, 05 Jun 2023 01:27:44 GMT\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br"),t("span",{staticClass:"line-number"},[e._v("8")]),t("br"),t("span",{staticClass:"line-number"},[e._v("9")]),t("br"),t("span",{staticClass:"line-number"},[e._v("10")]),t("br"),t("span",{staticClass:"line-number"},[e._v("11")]),t("br"),t("span",{staticClass:"line-number"},[e._v("12")]),t("br"),t("span",{staticClass:"line-number"},[e._v("13")]),t("br")])]),t("p",[e._v("连接请求")]),e._v(" "),t("div",{staticClass:"language-text line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("CONNECT\nAuthorization:Bearer xxx\naccept-version:1.1,1.0\nheart-beat:20000,0\n\n\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br")])]),t("p",[e._v("连接响应")]),e._v(" "),t("div",{staticClass:"language-text line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("CONNECTED\nversion:1.1\nheart-beat:0,0\nuser-name:1111\n\n\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br")])]),t("p",[e._v("消息")]),e._v(" "),t("div",{staticClass:"language-text line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("MESSAGE\ndestination:/receive/group/message\ncontent-type:text/plain;charset=UTF-8\nsubscription:1111\nmessage-id:49eede7f-41de-6cd5-3503-d9e4a7989bae-0\ncontent-length:10\n\nhello 1111\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br"),t("span",{staticClass:"line-number"},[e._v("8")]),t("br")])]),t("h3",{attrs:{id:"_3-解析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-解析"}},[e._v("#")]),e._v(" 3.解析")]),e._v(" "),t("p",[e._v("从http报文"),t("code",[e._v("Sec-WebSocket-Protocol: v10.stomp, v11.stomp")]),e._v("来看，stomp是作为websocket的一个子协议工作的。\nstomp规定了消息的格式，而websocket并没有规定。")]),e._v(" "),t("p",[e._v("握手完成后，stomp客户端提供了3个操作:")]),e._v(" "),t("ul",[t("li",[e._v("CONNECT")]),e._v(" "),t("li",[e._v("SUBSCRIBE")]),e._v(" "),t("li",[e._v("SEND")])]),e._v(" "),t("p",[e._v("对应服务端2种响应:")]),e._v(" "),t("ul",[t("li",[e._v("CONNECTED")]),e._v(" "),t("li",[e._v("MESSAGE")])]),e._v(" "),t("h3",{attrs:{id:"_4-鉴权"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-鉴权"}},[e._v("#")]),e._v(" 4.鉴权")]),e._v(" "),t("p",[e._v("stomp允许在消息中添加请求头，但并非在握手阶段传递，这一点因为其作为websocket子协议，两者一致。握手完成后会在 "),t("code",[e._v("CONNECT")]),e._v(" 消息添加\n"),t("code",[e._v("Authorization:Bearer xxx")]),e._v(" -> "),t("code",[e._v("user-name:1111")]),e._v("\n在提供token并解析后，spring会自动将user-name赋值并返回，如果是jwt就是subject的值。同时stomp客户端建议使用这个值作为订阅id。")]),e._v(" "),t("h3",{attrs:{id:"_5-实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-实现"}},[e._v("#")]),e._v(" 5.实现")]),e._v(" "),t("blockquote",[t("p",[t("a",{attrs:{href:"https://github.com/netty/netty/blob/4.1/example/src/main/java/io/netty/example/stomp",target:"_blank",rel:"noopener noreferrer"}},[e._v("netty-example"),t("OutboundLink")],1)])]),e._v(" "),t("blockquote",[t("p",[t("a",{attrs:{href:"https://github.com/heartape/study/tree/main/frame/spring-websocket",target:"_blank",rel:"noopener noreferrer"}},[e._v("github-spring-websocket-stomp"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=n.exports}}]);