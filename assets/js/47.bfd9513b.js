(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{527:function(s,t,a){"use strict";a.r(t);var n=a(0),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"_1-mysql"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-mysql"}},[s._v("#")]),s._v(" 1.mysql")]),s._v(" "),t("h3",{attrs:{id:"_1-索引"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-索引"}},[s._v("#")]),s._v(" 1.索引")]),s._v(" "),t("h4",{attrs:{id:"_1-b-tree"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-b-tree"}},[s._v("#")]),s._v(" 1.B+TREE")]),s._v(" "),t("p",[s._v("B+ TREE相比其他结构来说有非常大的优势")]),s._v(" "),t("ul",[t("li",[s._v("相比B TREE来说，因为数据都在叶子节点，查找相邻数据时可以通过左右指针来查找，而不用通过树结构往上回溯。")]),s._v(" "),t("li",[s._v("相比hash来说，不会存在hash冲突，所以更稳定，并且hash是散列的，不能支持排序和范围查询。")])]),s._v(" "),t("h3",{attrs:{id:"_2-innodb索引的特点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-innodb索引的特点"}},[s._v("#")]),s._v(" 2.InnoDB索引的特点")]),s._v(" "),t("ul",[t("li",[s._v("主键索引为聚集索引，同时保存了所有数据（如果没有主键，系统会隐式地创建）。")]),s._v(" "),t("li",[s._v("二级索引为非聚集索引，保存了主键值，用于到主键索引二次查询（即回表）。")])]),s._v(" "),t("h4",{attrs:{id:"_2-最左匹配原则"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-最左匹配原则"}},[s._v("#")]),s._v(" 2.最左匹配原则")]),s._v(" "),t("p",[s._v("联合索引不会保存数据所以当使用索引时，会先拿到主键，再回表拿数据。但当需要查询的数据在索引中时，便可以利用最左匹配原则省去回表环节。比如："),t("br"),s._v("\n有一个a,b,c三个字段的联合索引，如果where条件中使用到了a=1,b=2,且查询对象时c时，就可以免去回表。"),t("br"),s._v("\n之所以叫最左匹配原则，是因为它严格要求索引的建立顺序必须条件在左，结果在右，这跟索引的数据结构有关。索引会把a和b字段建立成1对n的关系，所以无法逆向使用最左匹配原则。")]),s._v(" "),t("h4",{attrs:{id:"_3-性能调优"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-性能调优"}},[s._v("#")]),s._v(" 3.性能调优")]),s._v(" "),t("p",[s._v("1.鉴于mysql索引的排序机制，我们很容易得到第一点：主键。"),t("br"),s._v("\n一般来说，有序的主键性能更强。如果主键是十分散列的:")]),s._v(" "),t("ul",[t("li",[s._v("每次插入时都需要寻找插入的位置，效率低下。")]),s._v(" "),t("li",[s._v("由于需要排序，所以需要重新将数据向后移动，页满了以后会进行大量的页分裂操作，需要进行多次io。")]),s._v(" "),t("li",[s._v("由于频繁的页分裂，造成内存碎片化，分配的内存不能充分使用，后续查找数据也跟困难。")])]),s._v(" "),t("p",[s._v("2.充分利用最左匹配原则，减少索引的数量")]),s._v(" "),t("p",[s._v("3.只建立必要的索引，索引需要大量存储空间，并且在插入删除时需要维护索引，影响性能。")]),s._v(" "),t("h3",{attrs:{id:"_2-redo-log"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-redo-log"}},[s._v("#")]),s._v(" 2.redo log")]),s._v(" "),t("div",{staticClass:"language-text line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql为了减少硬盘IO提升性能，引入了Boffer Pool(缓冲池)。\n查询一条记录，先从Buffer Pool中找，没有命中会从硬盘把一页的数据加载出来，放入到Buffer Pool中。\n修改也是会先存到Boffer Pool里头。\n然后使用后台线程去做缓冲池和磁盘之间的同步。\n此时，便需要使用redo log来记录这部分尚未写入数据，防止数据丢失。\n\nredo log叫做重做日志，是用来实现事务的持久性。\n该日志文件由两部分组成: 重做redo log buffer（日志缓冲）以及redo log（重做日志文件），前者是在内存中，后者在磁盘中。\n\nredo log有以下特性:\n- 顺序存储，写入性能更好。\n- 只要事务一提交，便将redo log buffer刷盘到redo log，保证事务的持久性(innodb_flush_log_at_trx_commit=1)。\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("h3",{attrs:{id:"_3-multi-version"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-multi-version"}},[s._v("#")]),s._v(" 3.multi-version")]),s._v(" "),t("div",{staticClass:"language-text line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("InnoDB is a multi-version storage engine. \nIt keeps information about old versions of changed rows to support transactional features such as concurrency and rollback. \nThis information is stored in undo tablespaces in a data structure called a rollback segment.\n\n数据库内部会向数据库中存储的每一行添加三个字段:\nDB_TRX_ID: 6-byte。transaction identifier。最后进行插入或更新的事务标识符，没有删除是因为删除在底层就是更新，将特殊标志位更新为已删除。\nDB_ROLL_PTR: 7-byte。roll pointer。指向undo log的指针。\nDB_ROW_IDInnoDBDB_ROW_ID: 6-byte。row ID。行ID随着新行的插入而单调增加，只会出现在默认生成的主键索引中。\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("div",{staticClass:"language-text line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("Undo logs in the rollback segment are divided into insert and update undo logs. \nInsert undo logs are needed only in transaction rollback and can be discarded as soon as the transaction commits. \nUpdate undo logs are used also in consistent reads, but they can be discarded only after there is no transaction present for which has assigned a snapshot that in a consistent read could require the information in the update undo log to build an earlier version of a database row.\n\n总结:\n- 有事务才会Insert undo log\n- undo log可用于事务回滚。\n- undo log保存了修改前的数据，可以作为旧版本快照的数据，以供快照读。\n\n注意点:It is recommend that you commit transactions regularly, including transactions that issue only consistent reads. Otherwise, cannot discard data from the update undo logs, and the rollback segment may grow too big, filling up the undo tablespace in which it resides. \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("div",{staticClass:"language-text line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("InnoDB multiversion concurrency control (MVCC) treats secondary indexes differently than clustered indexes. \nRecords in a clustered index are updated in-place, and their hidden system columns point undo log entries from which earlier versions of records can be reconstructed. \nUnlike clustered index records, secondary index records do not contain hidden system columns nor are they updated in-place.\n\nWhen a secondary index column is updated, old secondary index records are delete-marked, new records are inserted, and delete-marked records are eventually purged. \nWhen a secondary index record is delete-marked or the secondary index page is updated by a newer transaction, looks up the database record in the clustered index. \nIn the clustered index, the record's is checked, and the correct version of the record is retrieved from the undo log if the record was modified after the reading transaction was initiated. \n\nIf a secondary index record is marked for deletion or the secondary index page is updated by a newer transaction, the covering index technique is not used. \nInstead of returning values from the index structure, looks up the record in the clustered index. \n\nHowever, if the index condition pushdown (ICP) optimization is enabled, and parts of the condition can be evaluated using only fields from the index, the MySQL server still pushes this part of the condition down to the storage engine where it is evaluated using the index. \nIf no matching records are found, the clustered index lookup is avoided. \nIf matching records are found, even among delete-marked records, looks up the record in the clustered index.\n\n以上主要说明，MVCC对于主键索引和非主键索引的处理并不一致。\n由于主键索引存储了数据，通过隐藏的3个字段，可以立即更新然后指向undo log。\n而二级索引只能打上已删除的标记，并不立即更新，只插入新的值，为旧的数据打上删除标记。\n如果二级索引被其他事务更新或删除，会导致索引失效。但是索引条件下推优化避免索引失效。\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("h3",{attrs:{id:"_4-锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-锁"}},[s._v("#")]),s._v(" 4.锁")]),s._v(" "),t("p",[s._v("在事务中因为需要解决脏读、幻读等问题需要加锁，只会在事务提交时才会被释放。")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 通过创建innodb_monitor开启监控")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" innodb_monitor "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INT")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENGINE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INNODB")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DROP")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" innodb_monitor"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 通过参数开启监控")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GLOBAL")]),s._v(" innodb_status_output_locks"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GLOBAL")]),s._v(" innodb_status_output_locks"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("OFF")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查看事务 ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" information_schema"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("INNODB_TRX"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("ul",[t("li",[s._v("全局锁: 全库逻辑备份（mysqldump），命令 "),t("code",[s._v("Flush tables with read lock (FTWRL)")]),s._v("，会导致业务停止，主从延迟。")]),s._v(" "),t("li",[s._v("表级锁:\n"),t("ul",[t("li",[s._v("lock: "),t("code",[s._v("unlock tables;")]),s._v("解锁。\n"),t("ul",[t("li",[t("code",[s._v("lock tables book read;")]),s._v("，当前连接可以读，写报错。其他连接可以读，写等待。")]),s._v(" "),t("li",[t("code",[s._v("lock tables book write;")]),s._v("，当前连接可以写，读等待。其他连接读写等待。")])])]),s._v(" "),t("li",[s._v("元数据锁(MDL): 不需要显式使用。增删改查操作的时候，加MDL读锁；当要对表做结构变更操作的时候，加MDL写锁。")])])]),s._v(" "),t("li",[s._v("行级锁: 粒度最低的锁。行锁通过锁索引（一定会锁主键索引）来加锁，因为每次都通过where查找索引给数据加锁性能太低，这也导致了没有索引的情况会锁表。也是下面要详细说的部分。")])]),s._v(" "),t("h5",{attrs:{id:"共享锁、排它锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#共享锁、排它锁"}},[s._v("#")]),s._v(" 共享锁、排它锁")]),s._v(" "),t("ul",[t("li",[s._v("共享锁(s)"),t("code",[s._v("select * from book where id = 1 lock in share mode")]),s._v(": permits the transaction that holds the lock to read a row.")]),s._v(" "),t("li",[s._v("排它锁(x)"),t("code",[s._v("select * from book where id = 1 for update")]),s._v(": permits the transaction that holds the lock to update or delete a row.a request from some distinct transaction for a lock of either type on cannot be granted immediately. transaction has to wait for transaction to release its lock on row.")])]),s._v(" "),t("h5",{attrs:{id:"记录锁、间隙锁、临键锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#记录锁、间隙锁、临键锁"}},[s._v("#")]),s._v(" 记录锁、间隙锁、临键锁")]),s._v(" "),t("ul",[t("li",[s._v("记录锁: "),t("code",[s._v("select * from student where id = 3 for update")])]),s._v(" "),t("li",[s._v("间隙锁:\n"),t("ul",[t("li",[t("code",[s._v("select * from student where id = 5 for update")]),s._v("（id主键索引，有值3、7，没有5）;")]),s._v(" "),t("li",[t("code",[s._v("select * from student where id = 35 for update")]),s._v("（age普通索引，有值25、36）")])])]),s._v(" "),t("li",[s._v("临键锁: "),t("code",[s._v("select * from student where age = 36 for update")]),s._v("（age普通索引，有值25、36、45）")])]),s._v(" "),t("div",{staticClass:"language-text line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("记录锁\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n|                  2334 | test_db       | student     | NULL       | TABLE     | IX            | GRANTED     | NULL      |\n|                  2334 | test_db       | student     | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 1         |\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n\n间隙锁(id in (4, 6)会被锁住)\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+\n|                  2359 | test_db       | student     | NULL       | TABLE     | IX        | GRANTED     | NULL      |\n|                  2359 | test_db       | student     | PRIMARY    | RECORD    | X,GAP     | GRANTED     | 6         |\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+\n\n间隙锁(age in (26, 35)会被锁住)\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+\n|                  2435 | test_db       | student     | NULL       | TABLE     | IX        | GRANTED     | NULL      |\n|                  2435 | test_db       | student     | age        | RECORD    | X,GAP     | GRANTED     | 36, 15    |\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+\n\n临键锁(age in (26, 44) or id=15会被锁住，普通索引命中反而锁得更多)\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n|                  2418 | test_db       | student     | NULL       | TABLE     | IX            | GRANTED     | NULL      |\n|                  2418 | test_db       | student     | age        | RECORD    | X             | GRANTED     | 36, 15    |\n|                  2418 | test_db       | student     | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 15        |\n|                  2418 | test_db       | student     | age        | RECORD    | X,GAP         | GRANTED     | 45, 1     |\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br")])]),t("h5",{attrs:{id:"意向锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#意向锁"}},[s._v("#")]),s._v(" 意向锁")]),s._v(" "),t("p",[s._v("Intention locks are table-level locks that indicate which type of lock (shared or exclusive) a transaction requires later for a row in a table.\nA lock is granted to a requesting transaction if it is compatible with existing locks, but not if it conflicts with existing locks.\nA transaction waits until the conflicting existing lock is released.\nIf a lock request conflicts with an existing lock and cannot be granted because it would cause deadlock, an error occurs.")]),s._v(" "),t("p",[s._v("大致意思就是，意向锁是一种提前声明，声明了当前表有共享锁或排它锁，省去每次扫描。虽然是表锁，其他事务在不冲突的情况下也可以获取锁。")]),s._v(" "),t("p",[s._v("分类:")]),s._v(" "),t("ul",[t("li",[s._v("意向共享锁: a transaction intends to set a shared lock on individual rows in a table.(IS)"),t("code",[s._v("SELECT ... FOR SHARE")]),s._v("。")]),s._v(" "),t("li",[s._v("意向排它锁: a transaction intends to set an exclusive lock on individual rows in a table.(IX)"),t("code",[s._v("SELECT ... FOR UPDATE")]),s._v("。")])]),s._v(" "),t("p",[s._v("协议:")]),s._v(" "),t("ul",[t("li",[s._v("意向共享锁: Before a transaction can acquire a shared lock on a row in a table, it must first acquire an lock or stronger on the table.")]),s._v(" "),t("li",[s._v("意向排它锁: Before a transaction can acquire an exclusive lock on a row in a table, it must first acquire an lock on the table.")])]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 意向共享锁")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" book "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHARE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- lock")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" ENGINE_TRANSACTION_ID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("OBJECT_SCHEMA"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("OBJECT_NAME"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("INDEX_NAME"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("LOCK_TYPE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("LOCK_MODE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("LOCK_STATUS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("LOCK_DATA "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" performance_schema"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("data_locks"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- innodb")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("engine")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("innodb")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMIT")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("div",{staticClass:"language-text line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("锁信息:\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA              |\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+\n|       421428622781656 | test_db       | book        | NULL       | TABLE     | IS        | GRANTED     | NULL                   |\n|       421428622781656 | test_db       | book        | PRIMARY    | RECORD    | S         | GRANTED     | 1                      |\n|       421428622781656 | test_db       | book        | PRIMARY    | RECORD    | S         | GRANTED     | 2                      |\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+\n\n可以看到IS锁并不用来锁住数据，本质上还是使用记录锁。下面是意向锁锁全表时的记录:\n\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA              |\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+\n|       421428622781656 | test_db       | book        | NULL       | TABLE     | IS        | GRANTED     | NULL                   |\n|       421428622781656 | test_db       | book        | PRIMARY    | RECORD    | S         | GRANTED     | supremum pseudo-record |\n|       421428622781656 | test_db       | book        | PRIMARY    | RECORD    | S         | GRANTED     | 1                      |\n|       421428622781656 | test_db       | book        | PRIMARY    | RECORD    | S         | GRANTED     | 2                      |\n+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 意向排它锁")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" book "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- lock")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" ENGINE_TRANSACTION_ID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("OBJECT_SCHEMA"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("OBJECT_NAME"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("INDEX_NAME"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("LOCK_TYPE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("LOCK_MODE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("LOCK_STATUS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("LOCK_DATA "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" performance_schema"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("data_locks"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- innodb")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("engine")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("innodb")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMIT")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("div",{staticClass:"language-text line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("锁信息:\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n|                  2869 | test          | book        | NULL       | TABLE     | IX            | GRANTED     | NULL      |\n|                  2869 | test          | book        | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 1         |\n|                  2869 | test          | book        | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 2         |\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+\n\n可以看到IX锁并不用来锁住数据，本质上还是使用记录锁。下面是意向锁锁全表时的记录:\n\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+------------------------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA              |\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+------------------------+\n|                  2869 | test          | book        | NULL       | TABLE     | IX            | GRANTED     | NULL                   |\n|                  2869 | test          | book        | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | supremum pseudo-record |\n|                  2869 | test          | book        | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 1                      |\n|                  2869 | test          | book        | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 2                      |\n+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+------------------------+\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("h5",{attrs:{id:"插入意向锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#插入意向锁"}},[s._v("#")]),s._v(" 插入意向锁")]),s._v(" "),t("p",[s._v("An insert intention lock is a type of gap lock(间隙锁)。官方文档将插入意向锁作为单独一种。")]),s._v(" "),t("p",[s._v("连接1")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" book "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("div",{staticClass:"language-text line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("查看锁信息\nTABLE LOCK table `flink`.`book` trx id 2328 lock mode IX\nRECORD LOCKS space id 2 page no 4 n bits 72 index PRIMARY of table `flink`.`book` trx id 2328 lock_mode X\n\n+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE          | LOCK_STATUS | LOCK_DATA              |\n+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+\n|                  2328 | test_db       | book        | NULL       | TABLE     | IX                 | GRANTED     | NULL                   |\n|                  2328 | test_db       | book        | PRIMARY    | RECORD    | X                  | GRANTED     | supremum pseudo-record |\n|                  2328 | test_db       | book        | PRIMARY    | RECORD    | X                  | GRANTED     | 2                      |\n|                  2328 | test_db       | book        | PRIMARY    | RECORD    | X                  | GRANTED     | 3                      |\n+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("连接2")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 执行并等待")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("book"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'代数'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("再次查看锁")]),s._v(" "),t("div",{staticClass:"language-text line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("RECORD LOCKS space id 2 page no 4 n bits 72 index PRIMARY of table `flink`.`book` trx id 2329 lock_mode X insert intention waiting\n\nTABLE LOCK table `flink`.`book` trx id 2328 lock mode IX\nRECORD LOCKS space id 2 page no 4 n bits 72 index PRIMARY of table `flink`.`book` trx id 2328 lock_mode X\n\n+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+\n| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE          | LOCK_STATUS | LOCK_DATA              |\n+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+\n|                  2331 | test_db       | book        | NULL       | TABLE     | IX                 | GRANTED     | NULL                   |\n|                  2331 | test_db       | book        | PRIMARY    | RECORD    | X,INSERT_INTENTION | WAITING     | supremum pseudo-record |\n|                  2328 | test_db       | book        | NULL       | TABLE     | IX                 | GRANTED     | NULL                   |\n|                  2328 | test_db       | book        | PRIMARY    | RECORD    | X                  | GRANTED     | supremum pseudo-record |\n|                  2328 | test_db       | book        | PRIMARY    | RECORD    | X                  | GRANTED     | 2                      |\n|                  2328 | test_db       | book        | PRIMARY    | RECORD    | X                  | GRANTED     | 3                      |\n+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+\n无法获取到锁，随后insert失败。\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("h3",{attrs:{id:"_5-事务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-事务"}},[s._v("#")]),s._v(" 5.事务")]),s._v(" "),t("p",[s._v("事务的特点:")]),s._v(" "),t("ul",[t("li",[s._v("原子性(Atomicity)")]),s._v(" "),t("li",[s._v("一致性(Consistency)")]),s._v(" "),t("li",[s._v("隔离型(Isolation)")]),s._v(" "),t("li",[s._v("持久性(Durability)")])]),s._v(" "),t("p",[s._v("隔离级别")]),s._v(" "),t("div",{staticClass:"language-text line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("- READ UNCOMMITED (读未提交): 不加锁，事物之间公开透明。脏读。\n- READ COMMITED (读已提交): 写加锁，读mvcc。因为在每次select时都会生成一个版本，所以会读取到其他事务已提交的数据，导致事务内读取前后不一致。不可重读、幻读。\n- REPEATABLE READ (可重复读): 写加锁，读mvcc。只会在最初select时生成一个版本，但是update, delete, insert等是当前读能操作select不到的数据。幻读。\n- SERIALIZABLE (串行化): 顺序读写。\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("事务等待信息查看")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v("\n  r"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("trx_id waiting_trx_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n  r"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("trx_mysql_thread_id waiting_thread"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n  r"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("trx_query waiting_query"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n  b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("trx_id blocking_trx_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n  b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("trx_mysql_thread_id blocking_thread"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n  b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("trx_query blocking_query \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" \n  performance_schema"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("data_lock_waits w \n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INNER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("JOIN")]),s._v(" information_schema"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("innodb_trx b \n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("trx_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" w"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("blocking_engine_transaction_id \n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INNER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("JOIN")]),s._v(" information_schema"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("innodb_trx r \n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" r"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("trx_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" w"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("requesting_engine_transaction_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("h4",{attrs:{id:"提交方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#提交方式"}},[s._v("#")]),s._v(" 提交方式")]),s._v(" "),t("div",{staticClass:"language-text line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("- 显示提交（显式事务）: begin; 'sql'; commit/rollback。此时相当于autocommit=OFF。\n- 隐式提交（隐式事务）: 在没有显式开启事务时，会为单个sql开启隐式事务。隐式提交会自动在sql语句后提交。需要autocommit=ON，否则需要手动commit。\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("显示提交:")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("book"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("title"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'牛x'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMIT")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("隐式提交:"),t("br"),s._v("\n连接1")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" VARIABLES "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("LIKE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'autocommit'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" autocommit "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("OFF")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("book"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("title"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'牛x'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("连接2会等待")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("book"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("title"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'牛xx'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token identifier"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);