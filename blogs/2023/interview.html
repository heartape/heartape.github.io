<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>面试题总结 | Heartape</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="favicon.ico">
    <script src="/assets/js/bodyClick.js"></script>
    <meta name="description" content="你也想起舞吗">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/assets/css/0.styles.a1a12807.css" as="style"><link rel="preload" href="/assets/js/app.0aaa76fd.js" as="script"><link rel="preload" href="/assets/js/3.67b42e06.js" as="script"><link rel="preload" href="/assets/js/1.ba3d0679.js" as="script"><link rel="preload" href="/assets/js/47.bfd9513b.js" as="script"><link rel="prefetch" href="/assets/js/10.e9699e73.js"><link rel="prefetch" href="/assets/js/11.8cba39cc.js"><link rel="prefetch" href="/assets/js/12.abedb4b9.js"><link rel="prefetch" href="/assets/js/13.684e984b.js"><link rel="prefetch" href="/assets/js/14.fabd1944.js"><link rel="prefetch" href="/assets/js/15.3a201786.js"><link rel="prefetch" href="/assets/js/16.0c1eeaf6.js"><link rel="prefetch" href="/assets/js/17.ee87c8cd.js"><link rel="prefetch" href="/assets/js/18.2a3010da.js"><link rel="prefetch" href="/assets/js/19.565e82f3.js"><link rel="prefetch" href="/assets/js/20.d3c75fe8.js"><link rel="prefetch" href="/assets/js/21.3d4ebbb8.js"><link rel="prefetch" href="/assets/js/22.2c24d75e.js"><link rel="prefetch" href="/assets/js/23.dcac00c6.js"><link rel="prefetch" href="/assets/js/24.ff211a1d.js"><link rel="prefetch" href="/assets/js/25.015a2c3e.js"><link rel="prefetch" href="/assets/js/26.6c3bca1f.js"><link rel="prefetch" href="/assets/js/27.0e6f5ba7.js"><link rel="prefetch" href="/assets/js/28.cc17e3aa.js"><link rel="prefetch" href="/assets/js/29.8a3dd91f.js"><link rel="prefetch" href="/assets/js/30.5514f209.js"><link rel="prefetch" href="/assets/js/31.4a4524b5.js"><link rel="prefetch" href="/assets/js/32.43607dfe.js"><link rel="prefetch" href="/assets/js/33.db213607.js"><link rel="prefetch" href="/assets/js/34.81cb7c32.js"><link rel="prefetch" href="/assets/js/35.fc02eb3e.js"><link rel="prefetch" href="/assets/js/36.03c09aeb.js"><link rel="prefetch" href="/assets/js/37.1ea7e6a7.js"><link rel="prefetch" href="/assets/js/38.d9548777.js"><link rel="prefetch" href="/assets/js/39.37d0f76c.js"><link rel="prefetch" href="/assets/js/4.98ef80d5.js"><link rel="prefetch" href="/assets/js/40.ebb103cd.js"><link rel="prefetch" href="/assets/js/41.8696b517.js"><link rel="prefetch" href="/assets/js/42.7e7d440d.js"><link rel="prefetch" href="/assets/js/43.9b2c4e79.js"><link rel="prefetch" href="/assets/js/44.9fdc51f4.js"><link rel="prefetch" href="/assets/js/45.5f256c35.js"><link rel="prefetch" href="/assets/js/46.c7c671fa.js"><link rel="prefetch" href="/assets/js/48.4bae39f1.js"><link rel="prefetch" href="/assets/js/49.2734277f.js"><link rel="prefetch" href="/assets/js/5.400b49fd.js"><link rel="prefetch" href="/assets/js/50.3d847444.js"><link rel="prefetch" href="/assets/js/51.40fc0ce6.js"><link rel="prefetch" href="/assets/js/52.f2868485.js"><link rel="prefetch" href="/assets/js/53.a3749151.js"><link rel="prefetch" href="/assets/js/54.c33cab28.js"><link rel="prefetch" href="/assets/js/55.12b6198c.js"><link rel="prefetch" href="/assets/js/56.cbbf6e6d.js"><link rel="prefetch" href="/assets/js/57.83b370a6.js"><link rel="prefetch" href="/assets/js/58.56ac42b0.js"><link rel="prefetch" href="/assets/js/59.d0e3af0f.js"><link rel="prefetch" href="/assets/js/6.31135b7c.js"><link rel="prefetch" href="/assets/js/60.e36f02c6.js"><link rel="prefetch" href="/assets/js/61.a4ed0070.js"><link rel="prefetch" href="/assets/js/62.23cebb58.js"><link rel="prefetch" href="/assets/js/63.a8bcb6de.js"><link rel="prefetch" href="/assets/js/64.b42d7871.js"><link rel="prefetch" href="/assets/js/65.bd815697.js"><link rel="prefetch" href="/assets/js/66.6cd45dd2.js"><link rel="prefetch" href="/assets/js/67.869a3181.js"><link rel="prefetch" href="/assets/js/68.44ff8c21.js"><link rel="prefetch" href="/assets/js/69.87c8573b.js"><link rel="prefetch" href="/assets/js/7.90420d98.js"><link rel="prefetch" href="/assets/js/70.eaa9c566.js"><link rel="prefetch" href="/assets/js/71.08b1859d.js"><link rel="prefetch" href="/assets/js/72.70ae92cf.js"><link rel="prefetch" href="/assets/js/73.92d31d2c.js"><link rel="prefetch" href="/assets/js/74.e0d458ba.js"><link rel="prefetch" href="/assets/js/75.e5a09edd.js"><link rel="prefetch" href="/assets/js/76.e022c340.js"><link rel="prefetch" href="/assets/js/77.ae12a4ee.js"><link rel="prefetch" href="/assets/js/78.3b44f8b4.js"><link rel="prefetch" href="/assets/js/79.df42e14c.js"><link rel="prefetch" href="/assets/js/8.cfca4993.js"><link rel="prefetch" href="/assets/js/80.4790094c.js"><link rel="prefetch" href="/assets/js/9.0c54c5b1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a1a12807.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-dad8a512><div data-v-dad8a512><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-dad8a512 data-v-dad8a512><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-dad8a512 data-v-dad8a512><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>Heartape</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Heartape</span>
            
          <span data-v-64685f0e>2022 - </span>
          2023
        </a></span></div></div> <div class="hide" data-v-dad8a512><header class="navbar" data-v-dad8a512><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/image/hero.png" alt="Heartape" class="logo"> <span class="site-name">Heartape</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-blog"></i>
      技术
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/docs/java/java8.html" class="nav-link"><i class="iconfont undefined"></i>
  JAVA
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/frame/spring5.html" class="nav-link"><i class="iconfont undefined"></i>
  框架
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/source/springSource.html" class="nav-link"><i class="iconfont undefined"></i>
  源码
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/middleware/mysql.html" class="nav-link"><i class="iconfont undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/tool/git.html" class="nav-link"><i class="iconfont undefined"></i>
  工具
</a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时光走过了哪里
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-account"></i>
      我在哪里
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/heartape" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/heartape" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  Gitee
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://space.bilibili.com/247318527" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-bilibili"></i>
  Bilibili
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="mailto:heartape@163.com" class="nav-link external"><i class="iconfont reco-mail"></i>
  163
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-dad8a512></div> <aside class="sidebar" data-v-dad8a512><div class="personal-info-wrapper" data-v-ca798c94 data-v-dad8a512><img src="/assets/image/hero.png" alt="author-avatar" class="personal-img" data-v-ca798c94> <h3 class="name" data-v-ca798c94>
    Heartape
  </h3> <div class="num" data-v-ca798c94><div data-v-ca798c94><h3 data-v-ca798c94>44</h3> <h6 data-v-ca798c94>文章</h6></div> <div data-v-ca798c94><h3 data-v-ca798c94>46</h3> <h6 data-v-ca798c94>标签</h6></div></div> <hr data-v-ca798c94></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-blog"></i>
      技术
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/docs/java/java8.html" class="nav-link"><i class="iconfont undefined"></i>
  JAVA
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/frame/spring5.html" class="nav-link"><i class="iconfont undefined"></i>
  框架
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/source/springSource.html" class="nav-link"><i class="iconfont undefined"></i>
  源码
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/middleware/mysql.html" class="nav-link"><i class="iconfont undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/tool/git.html" class="nav-link"><i class="iconfont undefined"></i>
  工具
</a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时光走过了哪里
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-account"></i>
      我在哪里
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/heartape" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/heartape" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  Gitee
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://space.bilibili.com/247318527" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-bilibili"></i>
  Bilibili
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="mailto:heartape@163.com" class="nav-link external"><i class="iconfont reco-mail"></i>
  163
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-dad8a512><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>面试题总结</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Heartape</span>
            
          <span data-v-64685f0e>2022 - </span>
          2023
        </a></span></div></div> <div data-v-dad8a512><main class="page"><div class="page-title" style="display:none;"><h1>面试题总结</h1> <div data-v-3b7f5bdf><i class="iconfont reco-account" data-v-3b7f5bdf><span data-v-3b7f5bdf>Heartape</span></i> <i class="iconfont reco-date" data-v-3b7f5bdf><span data-v-3b7f5bdf>2023-04-18</span></i> <!----> <i class="iconfont reco-tag tags" data-v-3b7f5bdf><span class="tag-item" data-v-3b7f5bdf>mysql</span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><h2 id="_1-mysql"><a href="#_1-mysql" class="header-anchor">#</a> 1.mysql</h2> <h3 id="_1-索引"><a href="#_1-索引" class="header-anchor">#</a> 1.索引</h3> <h4 id="_1-b-tree"><a href="#_1-b-tree" class="header-anchor">#</a> 1.B+TREE</h4> <p>B+ TREE相比其他结构来说有非常大的优势</p> <ul><li>相比B TREE来说，因为数据都在叶子节点，查找相邻数据时可以通过左右指针来查找，而不用通过树结构往上回溯。</li> <li>相比hash来说，不会存在hash冲突，所以更稳定，并且hash是散列的，不能支持排序和范围查询。</li></ul> <h3 id="_2-innodb索引的特点"><a href="#_2-innodb索引的特点" class="header-anchor">#</a> 2.InnoDB索引的特点</h3> <ul><li>主键索引为聚集索引，同时保存了所有数据（如果没有主键，系统会隐式地创建）。</li> <li>二级索引为非聚集索引，保存了主键值，用于到主键索引二次查询（即回表）。</li></ul> <h4 id="_2-最左匹配原则"><a href="#_2-最左匹配原则" class="header-anchor">#</a> 2.最左匹配原则</h4> <p>联合索引不会保存数据所以当使用索引时，会先拿到主键，再回表拿数据。但当需要查询的数据在索引中时，便可以利用最左匹配原则省去回表环节。比如：<br>
有一个a,b,c三个字段的联合索引，如果where条件中使用到了a=1,b=2,且查询对象时c时，就可以免去回表。<br>
之所以叫最左匹配原则，是因为它严格要求索引的建立顺序必须条件在左，结果在右，这跟索引的数据结构有关。索引会把a和b字段建立成1对n的关系，所以无法逆向使用最左匹配原则。</p> <h4 id="_3-性能调优"><a href="#_3-性能调优" class="header-anchor">#</a> 3.性能调优</h4> <p>1.鉴于mysql索引的排序机制，我们很容易得到第一点：主键。<br>
一般来说，有序的主键性能更强。如果主键是十分散列的:</p> <ul><li>每次插入时都需要寻找插入的位置，效率低下。</li> <li>由于需要排序，所以需要重新将数据向后移动，页满了以后会进行大量的页分裂操作，需要进行多次io。</li> <li>由于频繁的页分裂，造成内存碎片化，分配的内存不能充分使用，后续查找数据也跟困难。</li></ul> <p>2.充分利用最左匹配原则，减少索引的数量</p> <p>3.只建立必要的索引，索引需要大量存储空间，并且在插入删除时需要维护索引，影响性能。</p> <h3 id="_2-redo-log"><a href="#_2-redo-log" class="header-anchor">#</a> 2.redo log</h3> <div class="language-text line-numbers-mode"><pre class="language-text"><code>mysql为了减少硬盘IO提升性能，引入了Boffer Pool(缓冲池)。
查询一条记录，先从Buffer Pool中找，没有命中会从硬盘把一页的数据加载出来，放入到Buffer Pool中。
修改也是会先存到Boffer Pool里头。
然后使用后台线程去做缓冲池和磁盘之间的同步。
此时，便需要使用redo log来记录这部分尚未写入数据，防止数据丢失。

redo log叫做重做日志，是用来实现事务的持久性。
该日志文件由两部分组成: 重做redo log buffer（日志缓冲）以及redo log（重做日志文件），前者是在内存中，后者在磁盘中。

redo log有以下特性:
- 顺序存储，写入性能更好。
- 只要事务一提交，便将redo log buffer刷盘到redo log，保证事务的持久性(innodb_flush_log_at_trx_commit=1)。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_3-multi-version"><a href="#_3-multi-version" class="header-anchor">#</a> 3.multi-version</h3> <div class="language-text line-numbers-mode"><pre class="language-text"><code>InnoDB is a multi-version storage engine. 
It keeps information about old versions of changed rows to support transactional features such as concurrency and rollback. 
This information is stored in undo tablespaces in a data structure called a rollback segment.

数据库内部会向数据库中存储的每一行添加三个字段:
DB_TRX_ID: 6-byte。transaction identifier。最后进行插入或更新的事务标识符，没有删除是因为删除在底层就是更新，将特殊标志位更新为已删除。
DB_ROLL_PTR: 7-byte。roll pointer。指向undo log的指针。
DB_ROW_IDInnoDBDB_ROW_ID: 6-byte。row ID。行ID随着新行的插入而单调增加，只会出现在默认生成的主键索引中。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-text line-numbers-mode"><pre class="language-text"><code>Undo logs in the rollback segment are divided into insert and update undo logs. 
Insert undo logs are needed only in transaction rollback and can be discarded as soon as the transaction commits. 
Update undo logs are used also in consistent reads, but they can be discarded only after there is no transaction present for which has assigned a snapshot that in a consistent read could require the information in the update undo log to build an earlier version of a database row.

总结:
- 有事务才会Insert undo log
- undo log可用于事务回滚。
- undo log保存了修改前的数据，可以作为旧版本快照的数据，以供快照读。

注意点:It is recommend that you commit transactions regularly, including transactions that issue only consistent reads. Otherwise, cannot discard data from the update undo logs, and the rollback segment may grow too big, filling up the undo tablespace in which it resides. 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-text line-numbers-mode"><pre class="language-text"><code>InnoDB multiversion concurrency control (MVCC) treats secondary indexes differently than clustered indexes. 
Records in a clustered index are updated in-place, and their hidden system columns point undo log entries from which earlier versions of records can be reconstructed. 
Unlike clustered index records, secondary index records do not contain hidden system columns nor are they updated in-place.

When a secondary index column is updated, old secondary index records are delete-marked, new records are inserted, and delete-marked records are eventually purged. 
When a secondary index record is delete-marked or the secondary index page is updated by a newer transaction, looks up the database record in the clustered index. 
In the clustered index, the record's is checked, and the correct version of the record is retrieved from the undo log if the record was modified after the reading transaction was initiated. 

If a secondary index record is marked for deletion or the secondary index page is updated by a newer transaction, the covering index technique is not used. 
Instead of returning values from the index structure, looks up the record in the clustered index. 

However, if the index condition pushdown (ICP) optimization is enabled, and parts of the condition can be evaluated using only fields from the index, the MySQL server still pushes this part of the condition down to the storage engine where it is evaluated using the index. 
If no matching records are found, the clustered index lookup is avoided. 
If matching records are found, even among delete-marked records, looks up the record in the clustered index.

以上主要说明，MVCC对于主键索引和非主键索引的处理并不一致。
由于主键索引存储了数据，通过隐藏的3个字段，可以立即更新然后指向undo log。
而二级索引只能打上已删除的标记，并不立即更新，只插入新的值，为旧的数据打上删除标记。
如果二级索引被其他事务更新或删除，会导致索引失效。但是索引条件下推优化避免索引失效。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_4-锁"><a href="#_4-锁" class="header-anchor">#</a> 4.锁</h3> <p>在事务中因为需要解决脏读、幻读等问题需要加锁，只会在事务提交时才会被释放。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 通过创建innodb_monitor开启监控</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> innodb_monitor <span class="token punctuation">(</span>a <span class="token keyword">INT</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span><span class="token punctuation">;</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> innodb_monitor<span class="token punctuation">;</span>

<span class="token comment">-- 通过参数开启监控</span>
<span class="token keyword">set</span> <span class="token keyword">GLOBAL</span> innodb_status_output_locks<span class="token operator">=</span><span class="token keyword">ON</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> <span class="token keyword">GLOBAL</span> innodb_status_output_locks<span class="token operator">=</span><span class="token keyword">OFF</span><span class="token punctuation">;</span>

<span class="token comment">-- 查看事务 </span>
<span class="token keyword">select</span>  <span class="token operator">*</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>INNODB_TRX<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>全局锁: 全库逻辑备份（mysqldump），命令 <code>Flush tables with read lock (FTWRL)</code>，会导致业务停止，主从延迟。</li> <li>表级锁:
<ul><li>lock: <code>unlock tables;</code>解锁。
<ul><li><code>lock tables book read;</code>，当前连接可以读，写报错。其他连接可以读，写等待。</li> <li><code>lock tables book write;</code>，当前连接可以写，读等待。其他连接读写等待。</li></ul></li> <li>元数据锁(MDL): 不需要显式使用。增删改查操作的时候，加MDL读锁；当要对表做结构变更操作的时候，加MDL写锁。</li></ul></li> <li>行级锁: 粒度最低的锁。行锁通过锁索引（一定会锁主键索引）来加锁，因为每次都通过where查找索引给数据加锁性能太低，这也导致了没有索引的情况会锁表。也是下面要详细说的部分。</li></ul> <h5 id="共享锁、排它锁"><a href="#共享锁、排它锁" class="header-anchor">#</a> 共享锁、排它锁</h5> <ul><li>共享锁(s)<code>select * from book where id = 1 lock in share mode</code>: permits the transaction that holds the lock to read a row.</li> <li>排它锁(x)<code>select * from book where id = 1 for update</code>: permits the transaction that holds the lock to update or delete a row.a request from some distinct transaction for a lock of either type on cannot be granted immediately. transaction has to wait for transaction to release its lock on row.</li></ul> <h5 id="记录锁、间隙锁、临键锁"><a href="#记录锁、间隙锁、临键锁" class="header-anchor">#</a> 记录锁、间隙锁、临键锁</h5> <ul><li>记录锁: <code>select * from student where id = 3 for update</code></li> <li>间隙锁:
<ul><li><code>select * from student where id = 5 for update</code>（id主键索引，有值3、7，没有5）;</li> <li><code>select * from student where id = 35 for update</code>（age普通索引，有值25、36）</li></ul></li> <li>临键锁: <code>select * from student where age = 36 for update</code>（age普通索引，有值25、36、45）</li></ul> <div class="language-text line-numbers-mode"><pre class="language-text"><code>记录锁
+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+
| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+
|                  2334 | test_db       | student     | NULL       | TABLE     | IX            | GRANTED     | NULL      |
|                  2334 | test_db       | student     | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 1         |
+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+

间隙锁(id in (4, 6)会被锁住)
+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+
| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |
+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+
|                  2359 | test_db       | student     | NULL       | TABLE     | IX        | GRANTED     | NULL      |
|                  2359 | test_db       | student     | PRIMARY    | RECORD    | X,GAP     | GRANTED     | 6         |
+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+

间隙锁(age in (26, 35)会被锁住)
+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+
| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |
+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+
|                  2435 | test_db       | student     | NULL       | TABLE     | IX        | GRANTED     | NULL      |
|                  2435 | test_db       | student     | age        | RECORD    | X,GAP     | GRANTED     | 36, 15    |
+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+-----------+

临键锁(age in (26, 44) or id=15会被锁住，普通索引命中反而锁得更多)
+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+
| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+
|                  2418 | test_db       | student     | NULL       | TABLE     | IX            | GRANTED     | NULL      |
|                  2418 | test_db       | student     | age        | RECORD    | X             | GRANTED     | 36, 15    |
|                  2418 | test_db       | student     | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 15        |
|                  2418 | test_db       | student     | age        | RECORD    | X,GAP         | GRANTED     | 45, 1     |
+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h5 id="意向锁"><a href="#意向锁" class="header-anchor">#</a> 意向锁</h5> <p>Intention locks are table-level locks that indicate which type of lock (shared or exclusive) a transaction requires later for a row in a table.
A lock is granted to a requesting transaction if it is compatible with existing locks, but not if it conflicts with existing locks.
A transaction waits until the conflicting existing lock is released.
If a lock request conflicts with an existing lock and cannot be granted because it would cause deadlock, an error occurs.</p> <p>大致意思就是，意向锁是一种提前声明，声明了当前表有共享锁或排它锁，省去每次扫描。虽然是表锁，其他事务在不冲突的情况下也可以获取锁。</p> <p>分类:</p> <ul><li>意向共享锁: a transaction intends to set a shared lock on individual rows in a table.(IS)<code>SELECT ... FOR SHARE</code>。</li> <li>意向排它锁: a transaction intends to set an exclusive lock on individual rows in a table.(IX)<code>SELECT ... FOR UPDATE</code>。</li></ul> <p>协议:</p> <ul><li>意向共享锁: Before a transaction can acquire a shared lock on a row in a table, it must first acquire an lock or stronger on the table.</li> <li>意向排它锁: Before a transaction can acquire an exclusive lock on a row in a table, it must first acquire an lock on the table.</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token comment">-- 意向共享锁</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> book <span class="token keyword">where</span> id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">FOR</span> <span class="token keyword">SHARE</span><span class="token punctuation">;</span>
<span class="token comment">-- lock</span>
<span class="token keyword">SELECT</span> ENGINE_TRANSACTION_ID<span class="token punctuation">,</span>OBJECT_SCHEMA<span class="token punctuation">,</span>OBJECT_NAME<span class="token punctuation">,</span>INDEX_NAME<span class="token punctuation">,</span>LOCK_TYPE<span class="token punctuation">,</span>LOCK_MODE<span class="token punctuation">,</span>LOCK_STATUS<span class="token punctuation">,</span>LOCK_DATA <span class="token keyword">from</span> performance_schema<span class="token punctuation">.</span>data_locks<span class="token punctuation">;</span>
<span class="token comment">-- innodb</span>
<span class="token keyword">show</span> <span class="token keyword">engine</span> <span class="token keyword">innodb</span> <span class="token keyword">status</span><span class="token punctuation">;</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-text line-numbers-mode"><pre class="language-text"><code>锁信息:
+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+
| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA              |
+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+
|       421428622781656 | test_db       | book        | NULL       | TABLE     | IS        | GRANTED     | NULL                   |
|       421428622781656 | test_db       | book        | PRIMARY    | RECORD    | S         | GRANTED     | 1                      |
|       421428622781656 | test_db       | book        | PRIMARY    | RECORD    | S         | GRANTED     | 2                      |
+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+

可以看到IS锁并不用来锁住数据，本质上还是使用记录锁。下面是意向锁锁全表时的记录:

+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+
| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA              |
+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+
|       421428622781656 | test_db       | book        | NULL       | TABLE     | IS        | GRANTED     | NULL                   |
|       421428622781656 | test_db       | book        | PRIMARY    | RECORD    | S         | GRANTED     | supremum pseudo-record |
|       421428622781656 | test_db       | book        | PRIMARY    | RECORD    | S         | GRANTED     | 1                      |
|       421428622781656 | test_db       | book        | PRIMARY    | RECORD    | S         | GRANTED     | 2                      |
+-----------------------+---------------+-------------+------------+-----------+-----------+-------------+------------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token comment">-- 意向排它锁</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> book <span class="token keyword">where</span> id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>
<span class="token comment">-- lock</span>
<span class="token keyword">SELECT</span> ENGINE_TRANSACTION_ID<span class="token punctuation">,</span>OBJECT_SCHEMA<span class="token punctuation">,</span>OBJECT_NAME<span class="token punctuation">,</span>INDEX_NAME<span class="token punctuation">,</span>LOCK_TYPE<span class="token punctuation">,</span>LOCK_MODE<span class="token punctuation">,</span>LOCK_STATUS<span class="token punctuation">,</span>LOCK_DATA <span class="token keyword">from</span> performance_schema<span class="token punctuation">.</span>data_locks<span class="token punctuation">;</span>
<span class="token comment">-- innodb</span>
<span class="token keyword">show</span> <span class="token keyword">engine</span> <span class="token keyword">innodb</span> <span class="token keyword">status</span><span class="token punctuation">;</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-text line-numbers-mode"><pre class="language-text"><code>锁信息:
+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+
| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+
|                  2869 | test          | book        | NULL       | TABLE     | IX            | GRANTED     | NULL      |
|                  2869 | test          | book        | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 1         |
|                  2869 | test          | book        | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 2         |
+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+-----------+

可以看到IX锁并不用来锁住数据，本质上还是使用记录锁。下面是意向锁锁全表时的记录:

+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+------------------------+
| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA              |
+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+------------------------+
|                  2869 | test          | book        | NULL       | TABLE     | IX            | GRANTED     | NULL                   |
|                  2869 | test          | book        | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | supremum pseudo-record |
|                  2869 | test          | book        | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 1                      |
|                  2869 | test          | book        | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 2                      |
+-----------------------+---------------+-------------+------------+-----------+---------------+-------------+------------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h5 id="插入意向锁"><a href="#插入意向锁" class="header-anchor">#</a> 插入意向锁</h5> <p>An insert intention lock is a type of gap lock(间隙锁)。官方文档将插入意向锁作为单独一种。</p> <p>连接1</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> book <span class="token keyword">where</span> id <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-text line-numbers-mode"><pre class="language-text"><code>查看锁信息
TABLE LOCK table `flink`.`book` trx id 2328 lock mode IX
RECORD LOCKS space id 2 page no 4 n bits 72 index PRIMARY of table `flink`.`book` trx id 2328 lock_mode X

+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+
| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE          | LOCK_STATUS | LOCK_DATA              |
+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+
|                  2328 | test_db       | book        | NULL       | TABLE     | IX                 | GRANTED     | NULL                   |
|                  2328 | test_db       | book        | PRIMARY    | RECORD    | X                  | GRANTED     | supremum pseudo-record |
|                  2328 | test_db       | book        | PRIMARY    | RECORD    | X                  | GRANTED     | 2                      |
|                  2328 | test_db       | book        | PRIMARY    | RECORD    | X                  | GRANTED     | 3                      |
+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>连接2</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 执行并等待</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token identifier"><span class="token punctuation">`</span>book<span class="token punctuation">`</span></span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'代数'</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>再次查看锁</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>RECORD LOCKS space id 2 page no 4 n bits 72 index PRIMARY of table `flink`.`book` trx id 2329 lock_mode X insert intention waiting

TABLE LOCK table `flink`.`book` trx id 2328 lock mode IX
RECORD LOCKS space id 2 page no 4 n bits 72 index PRIMARY of table `flink`.`book` trx id 2328 lock_mode X

+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+
| ENGINE_TRANSACTION_ID | OBJECT_SCHEMA | OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE          | LOCK_STATUS | LOCK_DATA              |
+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+
|                  2331 | test_db       | book        | NULL       | TABLE     | IX                 | GRANTED     | NULL                   |
|                  2331 | test_db       | book        | PRIMARY    | RECORD    | X,INSERT_INTENTION | WAITING     | supremum pseudo-record |
|                  2328 | test_db       | book        | NULL       | TABLE     | IX                 | GRANTED     | NULL                   |
|                  2328 | test_db       | book        | PRIMARY    | RECORD    | X                  | GRANTED     | supremum pseudo-record |
|                  2328 | test_db       | book        | PRIMARY    | RECORD    | X                  | GRANTED     | 2                      |
|                  2328 | test_db       | book        | PRIMARY    | RECORD    | X                  | GRANTED     | 3                      |
+-----------------------+---------------+-------------+------------+-----------+--------------------+-------------+------------------------+
无法获取到锁，随后insert失败。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_5-事务"><a href="#_5-事务" class="header-anchor">#</a> 5.事务</h3> <p>事务的特点:</p> <ul><li>原子性(Atomicity)</li> <li>一致性(Consistency)</li> <li>隔离型(Isolation)</li> <li>持久性(Durability)</li></ul> <p>隔离级别</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>- READ UNCOMMITED (读未提交): 不加锁，事物之间公开透明。脏读。
- READ COMMITED (读已提交): 写加锁，读mvcc。因为在每次select时都会生成一个版本，所以会读取到其他事务已提交的数据，导致事务内读取前后不一致。不可重读、幻读。
- REPEATABLE READ (可重复读): 写加锁，读mvcc。只会在最初select时生成一个版本，但是update, delete, insert等是当前读能操作select不到的数据。幻读。
- SERIALIZABLE (串行化): 顺序读写。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>事务等待信息查看</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
  r<span class="token punctuation">.</span>trx_id waiting_trx_id<span class="token punctuation">,</span> 
  r<span class="token punctuation">.</span>trx_mysql_thread_id waiting_thread<span class="token punctuation">,</span> 
  r<span class="token punctuation">.</span>trx_query waiting_query<span class="token punctuation">,</span> 
  b<span class="token punctuation">.</span>trx_id blocking_trx_id<span class="token punctuation">,</span> 
  b<span class="token punctuation">.</span>trx_mysql_thread_id blocking_thread<span class="token punctuation">,</span> 
  b<span class="token punctuation">.</span>trx_query blocking_query 
<span class="token keyword">FROM</span> 
  performance_schema<span class="token punctuation">.</span>data_lock_waits w 
  <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> information_schema<span class="token punctuation">.</span>innodb_trx b 
      <span class="token keyword">ON</span> b<span class="token punctuation">.</span>trx_id <span class="token operator">=</span> w<span class="token punctuation">.</span>blocking_engine_transaction_id 
  <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> information_schema<span class="token punctuation">.</span>innodb_trx r 
      <span class="token keyword">ON</span> r<span class="token punctuation">.</span>trx_id <span class="token operator">=</span> w<span class="token punctuation">.</span>requesting_engine_transaction_id<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="提交方式"><a href="#提交方式" class="header-anchor">#</a> 提交方式</h4> <div class="language-text line-numbers-mode"><pre class="language-text"><code>- 显示提交（显式事务）: begin; 'sql'; commit/rollback。此时相当于autocommit=OFF。
- 隐式提交（隐式事务）: 在没有显式开启事务时，会为单个sql开启隐式事务。隐式提交会自动在sql语句后提交。需要autocommit=ON，否则需要手动commit。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>显示提交:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token keyword">update</span> <span class="token identifier"><span class="token punctuation">`</span>book<span class="token punctuation">`</span></span> <span class="token keyword">set</span> <span class="token identifier"><span class="token punctuation">`</span>title<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">'牛x'</span> <span class="token keyword">where</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>隐式提交:<br>
连接1</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'autocommit'</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> autocommit <span class="token operator">=</span> <span class="token keyword">OFF</span><span class="token punctuation">;</span>
<span class="token keyword">update</span> <span class="token identifier"><span class="token punctuation">`</span>book<span class="token punctuation">`</span></span> <span class="token keyword">set</span> <span class="token identifier"><span class="token punctuation">`</span>title<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">'牛x'</span> <span class="token keyword">where</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>连接2会等待</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">update</span> <span class="token identifier"><span class="token punctuation">`</span>book<span class="token punctuation">`</span></span> <span class="token keyword">set</span> <span class="token identifier"><span class="token punctuation">`</span>title<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token string">'牛xx'</span> <span class="token keyword">where</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2023/4/22 13:22:34</span></div></footer> <!----> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:2;" data-v-248d85d6></canvas></div><!----><div class="RibbonAnimation"></div><div id="goTop" class="hide-cat" data-v-bf92849a></div><div></div><div id="live2d-widget" class="live2d-widget-container" style="position:fixed;left:65px;bottom:0px;width:135px;height:300px;z-index:99999;opacity:1;pointer-events:none;"><canvas id="live2d_canvas" width="135" height="300" class="live2d_canvas" style="position:absolute;left:0px;top:0px;width:135px;height:300px;"></canvas></div></div></div>
    <script src="/assets/js/app.0aaa76fd.js" defer></script><script src="/assets/js/3.67b42e06.js" defer></script><script src="/assets/js/1.ba3d0679.js" defer></script><script src="/assets/js/47.bfd9513b.js" defer></script>
  </body>
</html>
