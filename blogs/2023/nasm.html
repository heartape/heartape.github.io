<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>x86汇编语言-从实模式到保护模式 | Heartape</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="favicon.ico">
    <script src="/assets/js/bodyClick.js"></script>
    <meta name="description" content="你也想起舞吗">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/assets/css/0.styles.a1a12807.css" as="style"><link rel="preload" href="/assets/js/app.3b750f1c.js" as="script"><link rel="preload" href="/assets/js/3.0afba0d4.js" as="script"><link rel="preload" href="/assets/js/1.d9ada6a7.js" as="script"><link rel="preload" href="/assets/js/52.3d1d0fd5.js" as="script"><link rel="prefetch" href="/assets/js/10.3ba0b48a.js"><link rel="prefetch" href="/assets/js/11.d1ce82e2.js"><link rel="prefetch" href="/assets/js/12.abc33c56.js"><link rel="prefetch" href="/assets/js/13.1f1fd4c3.js"><link rel="prefetch" href="/assets/js/14.6c6ab763.js"><link rel="prefetch" href="/assets/js/15.44208822.js"><link rel="prefetch" href="/assets/js/16.0a0d27be.js"><link rel="prefetch" href="/assets/js/17.93cc0748.js"><link rel="prefetch" href="/assets/js/18.ecab2ba6.js"><link rel="prefetch" href="/assets/js/19.874f7d88.js"><link rel="prefetch" href="/assets/js/20.071cd385.js"><link rel="prefetch" href="/assets/js/21.7ae70a4a.js"><link rel="prefetch" href="/assets/js/22.e8326cd3.js"><link rel="prefetch" href="/assets/js/23.e2a53224.js"><link rel="prefetch" href="/assets/js/24.f921c972.js"><link rel="prefetch" href="/assets/js/25.a5a7af93.js"><link rel="prefetch" href="/assets/js/26.3bb61d12.js"><link rel="prefetch" href="/assets/js/27.090fc656.js"><link rel="prefetch" href="/assets/js/28.860a5464.js"><link rel="prefetch" href="/assets/js/29.a24f3733.js"><link rel="prefetch" href="/assets/js/30.4bcff373.js"><link rel="prefetch" href="/assets/js/31.e7038cae.js"><link rel="prefetch" href="/assets/js/32.4f065bb0.js"><link rel="prefetch" href="/assets/js/33.23b514ad.js"><link rel="prefetch" href="/assets/js/34.57e6726a.js"><link rel="prefetch" href="/assets/js/35.d2e758eb.js"><link rel="prefetch" href="/assets/js/36.c4db7e59.js"><link rel="prefetch" href="/assets/js/37.c6d0b314.js"><link rel="prefetch" href="/assets/js/38.8ac0d36a.js"><link rel="prefetch" href="/assets/js/39.8818f776.js"><link rel="prefetch" href="/assets/js/4.2b85a100.js"><link rel="prefetch" href="/assets/js/40.47171523.js"><link rel="prefetch" href="/assets/js/41.06dc9d52.js"><link rel="prefetch" href="/assets/js/42.4ead7f53.js"><link rel="prefetch" href="/assets/js/43.a273b094.js"><link rel="prefetch" href="/assets/js/44.55bad01c.js"><link rel="prefetch" href="/assets/js/45.4613ff13.js"><link rel="prefetch" href="/assets/js/46.671dc75b.js"><link rel="prefetch" href="/assets/js/47.06701395.js"><link rel="prefetch" href="/assets/js/48.12d68297.js"><link rel="prefetch" href="/assets/js/49.0aa29ed7.js"><link rel="prefetch" href="/assets/js/5.8b9dcbfc.js"><link rel="prefetch" href="/assets/js/50.5131ba9b.js"><link rel="prefetch" href="/assets/js/51.bb4cf6f4.js"><link rel="prefetch" href="/assets/js/53.10b5b03f.js"><link rel="prefetch" href="/assets/js/54.410b4aff.js"><link rel="prefetch" href="/assets/js/55.ba4e8427.js"><link rel="prefetch" href="/assets/js/56.42bf645a.js"><link rel="prefetch" href="/assets/js/57.237e0a77.js"><link rel="prefetch" href="/assets/js/58.fb93ae78.js"><link rel="prefetch" href="/assets/js/59.514dee53.js"><link rel="prefetch" href="/assets/js/6.f1dd7dd8.js"><link rel="prefetch" href="/assets/js/60.360da120.js"><link rel="prefetch" href="/assets/js/61.4bc7c6b8.js"><link rel="prefetch" href="/assets/js/62.77efd971.js"><link rel="prefetch" href="/assets/js/63.6e1a3983.js"><link rel="prefetch" href="/assets/js/64.14dd06d1.js"><link rel="prefetch" href="/assets/js/65.69d74131.js"><link rel="prefetch" href="/assets/js/66.b8dcd8ca.js"><link rel="prefetch" href="/assets/js/67.23ee4a76.js"><link rel="prefetch" href="/assets/js/68.5dd6768e.js"><link rel="prefetch" href="/assets/js/69.b818f024.js"><link rel="prefetch" href="/assets/js/7.038a3598.js"><link rel="prefetch" href="/assets/js/70.82f781e4.js"><link rel="prefetch" href="/assets/js/71.17dd7914.js"><link rel="prefetch" href="/assets/js/72.0fba42b5.js"><link rel="prefetch" href="/assets/js/73.c0e12b69.js"><link rel="prefetch" href="/assets/js/74.28a050af.js"><link rel="prefetch" href="/assets/js/75.c20fef2a.js"><link rel="prefetch" href="/assets/js/76.439eb7dd.js"><link rel="prefetch" href="/assets/js/77.8e7fbbbd.js"><link rel="prefetch" href="/assets/js/78.296c630d.js"><link rel="prefetch" href="/assets/js/79.0156521c.js"><link rel="prefetch" href="/assets/js/8.6361775d.js"><link rel="prefetch" href="/assets/js/80.75e6321d.js"><link rel="prefetch" href="/assets/js/81.6387717a.js"><link rel="prefetch" href="/assets/js/82.5848da1f.js"><link rel="prefetch" href="/assets/js/83.ea1312e6.js"><link rel="prefetch" href="/assets/js/84.3baaf1b4.js"><link rel="prefetch" href="/assets/js/85.c5408647.js"><link rel="prefetch" href="/assets/js/9.49176af2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a1a12807.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-dad8a512><div data-v-dad8a512><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-dad8a512 data-v-dad8a512><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-dad8a512 data-v-dad8a512><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>Heartape</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Heartape</span>
            
          <span data-v-64685f0e>2022 - </span>
          2023
        </a></span></div></div> <div class="hide" data-v-dad8a512><header class="navbar" data-v-dad8a512><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/image/hero.png" alt="Heartape" class="logo"> <span class="site-name">Heartape</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-blog"></i>
      技术
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/docs/java/java8.html" class="nav-link"><i class="iconfont undefined"></i>
  JAVA
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/frame/spring5.html" class="nav-link"><i class="iconfont undefined"></i>
  框架
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/source/springSource.html" class="nav-link"><i class="iconfont undefined"></i>
  源码
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/middleware/mysql.html" class="nav-link"><i class="iconfont undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/tool/git.html" class="nav-link"><i class="iconfont undefined"></i>
  工具
</a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时光走过了哪里
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-account"></i>
      我在哪里
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/heartape" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/heartape" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  Gitee
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://space.bilibili.com/247318527" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-bilibili"></i>
  Bilibili
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="mailto:heartape@163.com" class="nav-link external"><i class="iconfont reco-mail"></i>
  163
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-dad8a512></div> <aside class="sidebar" data-v-dad8a512><div class="personal-info-wrapper" data-v-ca798c94 data-v-dad8a512><img src="/assets/image/hero.png" alt="author-avatar" class="personal-img" data-v-ca798c94> <h3 class="name" data-v-ca798c94>
    Heartape
  </h3> <div class="num" data-v-ca798c94><div data-v-ca798c94><h3 data-v-ca798c94>49</h3> <h6 data-v-ca798c94>文章</h6></div> <div data-v-ca798c94><h3 data-v-ca798c94>50</h3> <h6 data-v-ca798c94>标签</h6></div></div> <hr data-v-ca798c94></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-blog"></i>
      技术
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/docs/java/java8.html" class="nav-link"><i class="iconfont undefined"></i>
  JAVA
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/frame/spring5.html" class="nav-link"><i class="iconfont undefined"></i>
  框架
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/source/springSource.html" class="nav-link"><i class="iconfont undefined"></i>
  源码
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/middleware/mysql.html" class="nav-link"><i class="iconfont undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/blogs/docs/tool/git.html" class="nav-link"><i class="iconfont undefined"></i>
  工具
</a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时光走过了哪里
</a></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-account"></i>
      我在哪里
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/heartape" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/heartape" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  Gitee
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://space.bilibili.com/247318527" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-bilibili"></i>
  Bilibili
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="mailto:heartape@163.com" class="nav-link external"><i class="iconfont reco-mail"></i>
  163
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-dad8a512><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>x86汇编语言-从实模式到保护模式</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>Heartape</span>
            
          <span data-v-64685f0e>2022 - </span>
          2023
        </a></span></div></div> <div data-v-dad8a512><main class="page"><div class="page-title" style="display:none;"><h1>x86汇编语言-从实模式到保护模式</h1> <div data-v-3b7f5bdf><i class="iconfont reco-account" data-v-3b7f5bdf><span data-v-3b7f5bdf>Heartape</span></i> <i class="iconfont reco-date" data-v-3b7f5bdf><span data-v-3b7f5bdf>2023-09-06</span></i> <!----> <i class="iconfont reco-tag tags" data-v-3b7f5bdf><span class="tag-item" data-v-3b7f5bdf>nasm</span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><h2 id="_1-开始"><a href="#_1-开始" class="header-anchor">#</a> 1.开始</h2> <p>工欲善其事，必先利其器。
软件安装以及配置可以参考，内含实验源码。</p> <blockquote><p><a href="https://github.com/heartape/study-nasm" target="_blank" rel="noopener noreferrer">study-nasm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h2 id="_2-基本运算符"><a href="#_2-基本运算符" class="header-anchor">#</a> 2.基本运算符</h2> <div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code>AND
OR
XOR     <span class="token comment">; 常用于置0</span>
TEST
NOT

ADD
ADC     <span class="token comment">; 带进位加法</span>
SUB
SBB     <span class="token comment">; 带进位减法</span>
MUL	<span class="token register variable">bl</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token register variable">al</span> <span class="token operator">*</span> <span class="token register variable">bl</span><span class="token comment">; bx -&gt; ax * bx</span>
IMUL    <span class="token comment">; 有符号乘</span>
DIV	<span class="token register variable">ax</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token register variable">al</span>...<span class="token register variable">ah</span><span class="token comment">; (dx + ax) -&gt; ax...dx</span>
IDIV    <span class="token comment">; 有符号除</span>
INC
DEC
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code>shl        <span class="token comment">;左移</span>
shr        <span class="token comment">;右移</span>
sal        <span class="token comment">;有符号左移</span>
sar        <span class="token comment">;有符号右移</span>
rol        <span class="token comment">;循环左移</span>
ror        <span class="token comment">;循环右移</span>
rcl        <span class="token comment">;带进位的循环左移</span>
rcr        <span class="token comment">;带进位的循环右移</span>
shld       <span class="token comment">;双精度左移</span>
shrd       <span class="token comment">;双精度右移</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code>movsb       <span class="token comment">;字节</span>
movsw       <span class="token comment">;字</span>
movsd       <span class="token comment">;双字</span>
movsq       <span class="token comment">;四字</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code><span class="token comment">;标志寄存器判断</span>
JC      <span class="token comment">;（Jump if Carry）当运算产生进位标志时，即CF=1时，跳转到目标程序处</span>
JNC     <span class="token comment">;当CF=0时跳转</span>
JZ      <span class="token comment">;当ZF=1时跳转</span>
JNZ     <span class="token comment">;当ZF=0时跳转</span>
JO      <span class="token comment">;当OF=1时跳转</span>
JNO     <span class="token comment">;当OF=0时跳转</span>
JP      <span class="token comment">;当PF=1时跳转</span>
<span class="token comment">; 依此类推，标志寄存器的各个位都有对应指令</span>

<span class="token comment">; 大小判断</span>
<span class="token comment">; A大于，B小于，E等于，N取反</span>
cmp <span class="token register variable">ax</span>,<span class="token register variable">bx</span>
JA      <span class="token comment">;表示ax&gt;bx</span>
JNA     <span class="token comment">;表示ax&lt;=bx</span>
JB      <span class="token comment">;表示ax&lt;bx</span>
JNB     <span class="token comment">;表示ax&gt;=bx</span>
JE      <span class="token comment">;表示ax=bx</span>
JNE     <span class="token comment">;表示ax&lt;&gt;bx</span>
<span class="token comment">;JAE、JNAE、JBE、JNBE.....</span>
<span class="token comment">;以上是无符号数的比较。</span>
<span class="token comment">;有符号数的比较将A换成G，将B换成L即可。</span>
<span class="token comment">;A=above B=below G=greater L=less</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code>ret  <span class="token comment">;ip</span>
retf <span class="token comment">;ip、cs</span>
iref <span class="token comment">;ip、cs、flag</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_3-实模式"><a href="#_3-实模式" class="header-anchor">#</a> 3.实模式</h2> <h3 id="_1-引导扇区"><a href="#_1-引导扇区" class="header-anchor">#</a> 1.引导扇区</h3> <div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code>times <span class="token number">510</span> <span class="token operator">-</span> (<span class="token operator">$</span> <span class="token operator">-</span> <span class="token operator">$</span><span class="token operator">$</span>) db <span class="token number">0</span> <span class="token comment">;计算需要填充的空格</span>
db <span class="token number">55h</span>, <span class="token number">0aah</span> <span class="token comment">;必须已55aa结尾,并且必须填满一个扇区</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_2-用户程序头部"><a href="#_2-用户程序头部" class="header-anchor">#</a> 2.用户程序头部</h3> <div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code><span class="token keyword">SECTION header</span> vstart<span class="token operator">=</span><span class="token number">0</span>
    program_length  dd program_end                  <span class="token comment">;1.用户程序的尺寸 dd progarm_end</span>
    code_entry      dw start                        <span class="token comment">;2.应用程序的入口点 dw 偏移地址</span>
                    dd section.code.start                              <span class="token comment">;dd 段地址</span>
    realloc_tbl_len dw (header_end<span class="token operator">-</span>code_segment)<span class="token operator">/</span><span class="token number">4</span>  <span class="token comment">;3.段重定位表长度 dw 长度</span>
    code_segment    dd section.code.start           <span class="token comment">;4.段重定位表数据 dd section.xxx.start</span>
    data_segment    dd section.data.start
    stack_segment   dd section.stack.start
<span class="token label function">header_ends:</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code><span class="token comment">;重定位段重定位表</span>
<span class="token comment">;将虚拟地址转换为实际的16位物理地址，用于[cs:ip]跳转</span>
<span class="token comment">;输入：DX-高16位地址,AX-低16位地址</span>
<span class="token comment">;返回：AX=16位段基地址 </span>
<span class="token label function">calc_segment_base:</span>
	push <span class="token register variable">dx</span>                          

	add <span class="token register variable">ax</span>,<span class="token operator">[</span><span class="token register variable">cs</span>:phy_base<span class="token operator">]</span>		<span class="token comment">;phy_base低16位</span>
	adc <span class="token register variable">dx</span>,<span class="token operator">[</span><span class="token register variable">cs</span>:phy_base<span class="token operator">+</span><span class="token number">0x02</span><span class="token operator">]</span>	<span class="token comment">;phy_base高16位</span>
	shr <span class="token register variable">ax</span>,<span class="token number">4</span>					<span class="token comment">;右移</span>
	ror <span class="token register variable">dx</span>,<span class="token number">4</span>					<span class="token comment">;循环右移</span>
	and <span class="token register variable">dx</span>,<span class="token number">0xf000</span>
	or <span class="token register variable">ax</span>,<span class="token register variable">dx</span> 					<span class="token comment">;将高四位地址转移到低16位组成段地址,为什么需要转为物理段地址？</span>

	pop <span class="token register variable">dx</span>
	ret

    phy_base dd <span class="token number">0x10000</span>             <span class="token comment">;用户程序被加载的物理起始地址</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="_3-io"><a href="#_3-io" class="header-anchor">#</a> 3.io</h3> <div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code><span class="token comment">;硬盘总共8个端口，每个端口8位</span>
<span class="token comment">;使用LBA28方式访问硬盘</span>
<span class="token comment">;0x1f2端口写入扇区数</span>
<span class="token comment">;需要28个比特来表示起始逻辑扇区号:0x1f3(8位)、0x1f4(8位)、0x1f5(8位)、0x1f6(4位)</span>
<span class="token comment">;0x1f6(8位) -&gt; 固定1 + 0(CHS)/1(LAB) + 固定1 + 0(主硬盘)/1(从硬盘) + 4位用于表示逻辑扇区号</span>
<span class="token comment">;0x1f7(8位) -&gt; 1(忙)/0 + 空x3 + 1(准备好交换数据)/0 + 空x2 + 1(前一个命令执行错误)/0</span>

mov <span class="token register variable">dx</span>,<span class="token number">0x1f2</span>
mov <span class="token register variable">al</span>,<span class="token number">0x01</span>
out <span class="token register variable">dx</span>,<span class="token register variable">al</span>       <span class="token comment">;0x1f2 -&gt; 扇区数</span>

mov <span class="token register variable">dx</span>,<span class="token number">0x1f3</span>
mov <span class="token register variable">al</span>,<span class="token number">0x02</span>
out <span class="token register variable">dx</span>,<span class="token register variable">al</span>       <span class="token comment">;0x1f3</span>

inc <span class="token register variable">dx</span>
mov <span class="token register variable">al</span>,<span class="token number">0x00</span>
out <span class="token register variable">dx</span>,<span class="token register variable">al</span>       <span class="token comment">;0x1f4</span>

inc <span class="token register variable">dx</span>
out <span class="token register variable">dx</span>,<span class="token register variable">al</span>       <span class="token comment">;0x1f5</span>

inc <span class="token register variable">dx</span>
mov <span class="token register variable">al</span>,<span class="token number">0xe0</span>
out <span class="token register variable">dx</span>,<span class="token register variable">al</span>       <span class="token comment">;0x1f6</span>

mov <span class="token register variable">dx</span>,<span class="token number">0x1f7</span>
mov <span class="token register variable">al</span>,<span class="token number">0x20</span>
out <span class="token register variable">dx</span>,<span class="token register variable">al</span>       <span class="token comment">;0x1f7 -&gt; 0x20(读)</span>

mov <span class="token register variable">dx</span>,<span class="token number">0x1f7</span> 
<span class="token label function">.waits:</span>
in <span class="token register variable">al</span>,<span class="token register variable">dx</span>        <span class="token comment">;0x1f7</span>
and <span class="token register variable">al</span>,<span class="token number">0x88</span>     <span class="token comment">;0B10001000</span>
cmp <span class="token register variable">al</span>,<span class="token number">0x08</span>     <span class="token comment">;0B00001000，查看是否准备好读取</span>
jnz .waits
 
mov <span class="token register variable">cx</span>,<span class="token number">256</span>      <span class="token comment">;读取一个扇区256字节</span>
mov <span class="token register variable">dx</span>,<span class="token number">0x1f0</span>
<span class="token label function">.read:</span>
in <span class="token register variable">ax</span>,<span class="token register variable">dx</span>        <span class="token comment">;0x1f0数据端口</span>
mov <span class="token operator">[</span><span class="token register variable">bx</span><span class="token operator">]</span>,<span class="token register variable">ax</span>
add <span class="token register variable">bx</span>,<span class="token number">2</span>
loop .read
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h3 id="_4-显卡"><a href="#_4-显卡" class="header-anchor">#</a> 4.显卡</h3> <div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code><span class="token comment">;请求操作0x0e号寄存器</span>
mov <span class="token register variable">dx</span>,<span class="token number">0x3d4</span>
mov <span class="token register variable">al</span>,<span class="token number">0x0e</span>
out <span class="token register variable">dx</span>,<span class="token register variable">al</span>

<span class="token comment">;读取屏幕光标位置的高8位</span>
mov <span class="token register variable">dx</span>,<span class="token number">0x3d5</span>
in <span class="token register variable">al</span>,<span class="token number">0x0e</span>
mov <span class="token register variable">ah</span>,<span class="token register variable">al</span>
<span class="token comment">;写入屏幕光标位置的高8位</span>
mov <span class="token register variable">dx</span>,<span class="token number">0x3d5</span>
mov <span class="token register variable">al</span>,<span class="token number">0x0e</span>
out <span class="token register variable">dx</span>,<span class="token register variable">al</span>

<span class="token comment">;请求操作0x0f号寄存器</span>
mov <span class="token register variable">dx</span>,<span class="token number">0x3d4</span>
mov <span class="token register variable">al</span>,<span class="token number">0x0f</span>
out <span class="token register variable">dx</span>,<span class="token register variable">al</span>

<span class="token comment">;读取屏幕光标位置的低8位</span>
mov <span class="token register variable">dx</span>,<span class="token number">0x3d5</span>
mov <span class="token register variable">al</span>,<span class="token number">0x0f</span>
in <span class="token register variable">al</span>,<span class="token register variable">dx</span>        <span class="token comment">;ax完整光标数据</span>
<span class="token comment">;写入屏幕光标位置的低8位</span>
mov <span class="token register variable">dx</span>,<span class="token number">0x3d5</span>
mov <span class="token register variable">al</span>,<span class="token number">0x0f</span>
out <span class="token register variable">dx</span>,<span class="token register variable">al</span>

cmp <span class="token register variable">cl</span>,<span class="token number">0x0d</span>     <span class="token comment">;是否回车符</span>
cmp <span class="token register variable">cl</span>,<span class="token number">0x0a</span>     <span class="token comment">;是否换行符</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="_5-中断"><a href="#_5-中断" class="header-anchor">#</a> 5.中断</h3> <div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code>cli     <span class="token comment">;禁止中断</span>
sti     <span class="token comment">;允许中断</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code><span class="token comment">;RTC 芯片设置</span>
mov <span class="token register variable">al</span>,<span class="token number">0x0b</span>     <span class="token comment">;RTC寄存器B的索引</span>
or <span class="token register variable">al</span>,<span class="token number">0x80</span>      <span class="token comment">;将 AL 的最高位置1,阻断NMI（表 9-2）</span>
out <span class="token number">0x70</span>,<span class="token register variable">al</span>     <span class="token comment">;端口0x70是RTC的寄存器地址索引端口</span>
mov <span class="token register variable">al</span>,<span class="token number">0x12</span>     <span class="token comment">;设置寄存器B的数据，禁止周期性中断，允许更新结束中断允许，BCD码，24小时制（表 9-3）</span>
out <span class="token number">0x71</span>,<span class="token register variable">al</span>     <span class="token comment">;端口0x71是RTC的数据端口</span>

mov <span class="token register variable">al</span>,<span class="token number">0x0c</span>
out <span class="token number">0x70</span>,<span class="token register variable">al</span>
in <span class="token register variable">al</span>,<span class="token number">0x71</span>       <span class="token comment">;读RTC寄存器C，表明中断已经得到处理，可以继续下一次中断，否则不会产生中断信号（不考虑闹钟和周期性中断的情况）</span>

<span class="token comment">;修改它内部的中断屏蔽寄存器 IMR,以允许中断</span>
in <span class="token register variable">al</span>,<span class="token number">0xa1</span>                         <span class="token comment">;从0xa1端口读8259从片的IMR寄存器</span>
and <span class="token register variable">al</span>,<span class="token number">0xfe</span>                        <span class="token comment">;清除bit 0(此位连接RTC，见书图 9-2)</span>
out <span class="token number">0xa1</span>,<span class="token register variable">al</span>                        <span class="token comment">;写回此寄存器</span>

hlt             <span class="token comment">;使CPU进入低功耗状态，直到被中断唤醒，可用于循环等待降低功耗</span>

<span class="token comment">;读RTC当前时间</span>
xor <span class="token register variable">al</span>,<span class="token register variable">al</span>       <span class="token comment">;0 -&gt; 秒，2 -&gt; 分，4 -&gt; 时</span>
or <span class="token register variable">al</span>,<span class="token number">0x80</span>
out <span class="token number">0x70</span>,<span class="token register variable">al</span>
in <span class="token register variable">al</span>,<span class="token number">0x71</span>
push <span class="token register variable">ax</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="_6-键盘"><a href="#_6-键盘" class="header-anchor">#</a> 6.键盘</h3> <div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code>mov <span class="token register variable">ah</span>,<span class="token number">0x00</span>     <span class="token comment">;从键盘读字符</span>
int <span class="token number">0x16</span>        <span class="token comment">;键盘服务，会持续监控键盘。返回时，字符代码在寄存器 AL 中</span>

in <span class="token register variable">al</span>,<span class="token number">0x60</span>      <span class="token comment">;通过端口读取，由0x9中断读取</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h3> <ul><li>字在内存中是小端存储</li> <li>双字在内存中也是小端存储</li></ul> <div class="language-text line-numbers-mode"><pre class="language-text"><code># c风格表示法
0x12 -&gt; 16进制
0O12 -&gt; 8进制
0B12 -&gt; 2进制
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code>shl <span class="token register variable">ax</span>,<span class="token number">4</span>    <span class="token comment">;左移</span>
shr <span class="token register variable">ax</span>,<span class="token number">4</span>    <span class="token comment">;右移</span>
rol <span class="token register variable">ax</span>,<span class="token number">4</span>    <span class="token comment">;循环左移,移出的比特既送到标志寄存器的CF位，也送进右边空出的位</span>
ror <span class="token register variable">ax</span>,<span class="token number">4</span>    <span class="token comment">;循环右移,同上</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code>length equ <span class="token number">100</span>      <span class="token comment">;声明常数 xxx equ 100,不会占用内存</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code>resb <span class="token number">256</span>    <span class="token comment">;（REServe Byte）内存中保留 256 字节</span>
resw <span class="token number">256</span>    <span class="token comment">;内存中保留 256 字</span>
resd <span class="token number">256</span>    <span class="token comment">;内存中保留 256 双字</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_4-32位保护模式"><a href="#_4-32位保护模式" class="header-anchor">#</a> 4.32位保护模式</h2> <h3 id="_1-保护模式"><a href="#_1-保护模式" class="header-anchor">#</a> 1.保护模式</h3> <div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code><span class="token comment">; 16位模式下运行32位指令，机器码前会加上 0x66，32位模式下运行16位指令同理</span>
inc <span class="token register variable">ax</span>      <span class="token comment">; 40</span>
inc <span class="token register variable">eax</span>     <span class="token comment">; 66 40</span>

<span class="token operator">[</span>bits <span class="token number">32</span><span class="token operator">]</span>   <span class="token comment">; 指定编译模式，默认16</span>

shl <span class="token register variable">eax</span>,<span class="token register variable">cl</span>   <span class="token comment">; 32位首先会做如下运算，保留后五位: and cl 0x1F，因此移动的次数最大为31</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_2-进入保护模式"><a href="#_2-进入保护模式" class="header-anchor">#</a> 2.进入保护模式</h3> <div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code><span class="token comment">; 这部分是基于linux0.11的源码</span>
<span class="token comment">; 把后面的值（gdt_48）放在 gdtr 寄存器中</span>
lgdt  <span class="token operator">[</span>gdt_48<span class="token operator">]</span>

<span class="token comment">; gdtr 寄存器</span>
<span class="token label function">gdt_48:</span>
    dw   <span class="token number">0x800</span>       <span class="token comment">; gdt limit=2048, 256 GDT entries</span>
    dw   <span class="token number">512</span><span class="token operator">+</span>gdt,<span class="token number">0x9</span> <span class="token comment">; gdt base = 0X9xxxx</span>

<span class="token comment">; gdt(全局描述符表)</span>
<span class="token label function">gdt:</span>
    dw   <span class="token number">0</span>,<span class="token number">0</span>,<span class="token number">0</span>,<span class="token number">0</span>     <span class="token comment">; 首个为空</span>

    dw   <span class="token number">0x07FF</span>      <span class="token comment">; 8Mb - limit=2047 (2048*4096=8Mb)</span>
    dw   <span class="token number">0x0000</span>      <span class="token comment">; base address=0</span>
    dw   <span class="token number">0x9A00</span>      <span class="token comment">; code read/exec</span>
    dw   <span class="token number">0x00C0</span>      <span class="token comment">; granularity=4096, 386</span>

    dw   <span class="token number">0x07FF</span>      <span class="token comment">; 8Mb - limit=2047 (2048*4096=8Mb)</span>
    dw   <span class="token number">0x0000</span>      <span class="token comment">; base address=0</span>
    dw   <span class="token number">0x9200</span>      <span class="token comment">; data read/write</span>
    dw   <span class="token number">0x00C0</span>      <span class="token comment">; granularity=4096, 386</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code><span class="token comment">; 打开 A20 地址线，为了突破地址信号线 20 位的宽度，变成 32 位可用。</span>
mov <span class="token register variable">al</span>,<span class="token number">0xD1</span>        <span class="token comment">; command write</span>
out <span class="token number">0x64</span>,<span class="token register variable">al</span>
mov <span class="token register variable">al</span>,<span class="token number">0xDF</span>        <span class="token comment">; A20 on</span>
out <span class="token number">0x60</span>,<span class="token register variable">al</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code><span class="token comment">; 对可编程中断控制器 8259 芯片进行的编程</span>
mov <span class="token register variable">al</span>,<span class="token number">0x11</span>        <span class="token comment">; initialization sequence</span>
out <span class="token number">0x20</span>,<span class="token register variable">al</span>        <span class="token comment">; send it to 8259A-1</span>
dw   <span class="token number">0x00eb</span>,<span class="token number">0x00eb</span>       <span class="token comment">; jmp $+2, jmp $+2</span>
out <span class="token number">0xA0</span>,<span class="token register variable">al</span>        <span class="token comment">; and to 8259A-2</span>
dw   <span class="token number">0x00eb</span>,<span class="token number">0x00eb</span>
mov <span class="token register variable">al</span>,<span class="token number">0x20</span>        <span class="token comment">; start of hardware int's (0x20)</span>
out <span class="token number">0x21</span>,<span class="token register variable">al</span>
dw   <span class="token number">0x00eb</span>,<span class="token number">0x00eb</span>
mov <span class="token register variable">al</span>,<span class="token number">0x28</span>        <span class="token comment">; start of hardware int's 2 (0x28)</span>
out <span class="token number">0xA1</span>,<span class="token register variable">al</span>
dw   <span class="token number">0x00eb</span>,<span class="token number">0x00eb</span>
mov <span class="token register variable">al</span>,<span class="token number">0x04</span>        <span class="token comment">; 8259-1 is master</span>
out <span class="token number">0x21</span>,<span class="token register variable">al</span>
dw   <span class="token number">0x00eb</span>,<span class="token number">0x00eb</span>
mov <span class="token register variable">al</span>,<span class="token number">0x02</span>        <span class="token comment">; 8259-2 is slave</span>
out <span class="token number">0xA1</span>,<span class="token register variable">al</span>
dw   <span class="token number">0x00eb</span>,<span class="token number">0x00eb</span>
mov <span class="token register variable">al</span>,<span class="token number">0x01</span>        <span class="token comment">; 8086 mode for both</span>
out <span class="token number">0x21</span>,<span class="token register variable">al</span>
dw   <span class="token number">0x00eb</span>,<span class="token number">0x00eb</span>
out <span class="token number">0xA1</span>,<span class="token register variable">al</span>
dw   <span class="token number">0x00eb</span>,<span class="token number">0x00eb</span>
mov <span class="token register variable">al</span>,<span class="token number">0xFF</span>        <span class="token comment">; mask off all interrupts for now</span>
out <span class="token number">0x21</span>,<span class="token register variable">al</span>
dw   <span class="token number">0x00eb</span>,<span class="token number">0x00eb</span>
out <span class="token number">0xA1</span>,<span class="token register variable">al</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><div class="language-text line-numbers-mode"><pre class="language-text"><code># 编程后的中断
PIC 请求号	中断号	用途
IRQ0	0x20	时钟中断
IRQ1	0x21	键盘中断
IRQ2	0x22	接连从芯片
IRQ3	0x23	串口2
IRQ4	0x24	串口1
IRQ5	0x25	并口2
IRQ6	0x26	软盘驱动器
IRQ7	0x27	并口1
IRQ8	0x28	实时钟中断
IRQ9	0x29	保留
IRQ10	0x2a	保留
IRQ11	0x2b	保留
IRQ12	0x2c	鼠标中断
IRQ13	0x2d	数学协处理器
IRQ14	0x2e	硬盘中断
IRQ15	0x2f	保留
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-nasm line-numbers-mode"><pre class="language-nasm"><code><span class="token comment">; 正式进入保护模式</span>
mov <span class="token register variable">ax</span>,<span class="token number">0x0001</span>  <span class="token comment">; protected mode (PE) bit</span>
lmsw <span class="token register variable">ax</span>      <span class="token comment">; This is it; 将 cr0 这个寄存器的位 0 置 1</span>
<span class="token comment">; 段选择子结构（16位） 0~1：RPL，2：TI，3~15：描述符索引（需要跳转的段基址在gdt中的位置）</span>
jmpi <span class="token number">0</span>,<span class="token number">8</span>     <span class="token comment">; 8 -&gt; 0000_0000_0000_1000 -&gt; 0_0000_0000_0001 -&gt; 1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></div> <footer class="page-edit" style="display:none;"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2023/9/20 06:31:31</span></div></footer> <!----> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:2;" data-v-248d85d6></canvas></div><!----><div class="RibbonAnimation"></div><div id="goTop" class="hide-cat" data-v-bf92849a></div><div></div><div id="live2d-widget" class="live2d-widget-container" style="position:fixed;left:65px;bottom:0px;width:135px;height:300px;z-index:99999;opacity:1;pointer-events:none;"><canvas id="live2d_canvas" width="135" height="300" class="live2d_canvas" style="position:absolute;left:0px;top:0px;width:135px;height:300px;"></canvas></div></div></div>
    <script src="/assets/js/app.3b750f1c.js" defer></script><script src="/assets/js/3.0afba0d4.js" defer></script><script src="/assets/js/1.d9ada6a7.js" defer></script><script src="/assets/js/52.3d1d0fd5.js" defer></script>
  </body>
</html>
